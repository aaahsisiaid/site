<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å†…ã‚«ãƒ¡ãƒ»å¤–ã‚«ãƒ¡æ’®å½±ã‚¢ãƒ—ãƒªï¼ˆEmailJSé€£æºï¼‰</title>

<style>
    body {
        margin: 0; padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
        cursor: pointer;
    }
    .container {
        max-width: 800px; margin: 0 auto; text-align: center;
    }
    .touch-area {
        background: rgba(255,255,255,0.1);
        border: 2px dashed rgba(255,255,255,0.3);
        border-radius: 15px;
        padding: 40px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 200px;
    }
    .touch-area:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
    }
    .media-container {
        margin: 20px 0;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        padding: 20px;
    }
    video,img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 10px 0;
    }
    .status {
        background: rgba(0,0,0,0.3);
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-size: 16px;
    }
    .data-display {
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: left;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
    }
    .error { color: #ff6b6b; background: rgba(255,107,107,0.1); }
    .success { color: #4CAF50; background: rgba(76,175,80,0.1); }
    .warning { color: #ff9800; background: rgba(255,152,0,0.1); }
    .debug-toggle {
        position: fixed; top: 10px; right: 10px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }
    .debug-info {
        background: rgba(0,0,0,0.7);
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 11px;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
</style>

<!-- EmailJS SDK æœ€æ–°ç‰ˆã«å¤‰æ›´ï¼ˆ2025å¹´7æœˆæ™‚ç‚¹ï¼‰ -->
<script src="https://cdn.emailjs.com/sdk/latest/email.min.js"></script>
<script defer>
  window.addEventListener('DOMContentLoaded', () => {
    if(window.emailjs){
      emailjs.init("cPjKBUm_i6HebDQF7");
      console.log("EmailJS initialized");
    } else {
      console.error("EmailJS SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
    }
  });
</script>

</head>
<body>
<button class="debug-toggle" onclick="toggleDebug()">Debug</button>

<div class="container">
    <h1>ğŸ“± å†…ã‚«ãƒ¡ãƒ»å¤–ã‚«ãƒ¡æ’®å½±ã‚¢ãƒ—ãƒª</h1>
    <p>ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§å†…ã‚«ãƒ¡ã¨å¤–ã‚«ãƒ¡ã®å†™çœŸã‚’æ’®ã‚Šã€ä½ç½®æƒ…å ±ã¨å‹•ç”»å†ç”Ÿå¾Œã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ã¾ã™</p>
    
    <div class="touch-area" id="touchArea" tabindex="0" role="button" aria-pressed="false" aria-label="æ’®å½±é–‹å§‹ãƒœã‚¿ãƒ³">
        <h2>ğŸ“± ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§å®Ÿè¡Œ</h2>
        <p>PC: ã‚¯ãƒªãƒƒã‚¯ | ã‚¹ãƒãƒ›: ã‚¿ãƒƒãƒ</p>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            å¤–ã‚«ãƒ¡å†™çœŸ â†’ å†…ã‚«ãƒ¡å†™çœŸ â†’ ä½ç½®æƒ…å ±å–å¾— â†’ å‹•ç”»å†ç”Ÿ â†’ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        </div>
    </div>
    
    <div class="status" id="status">å¾…æ©Ÿä¸­...</div>
    
    <div class="debug-info" id="debugInfo"></div>
    
    <div class="media-container">
        <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
        <canvas id="photoCanvas" style="display:none;"></canvas>
        <img id="capturedPhotoRear" style="display:none;" alt="å¤–ã‚«ãƒ¡å†™çœŸ">
        <img id="capturedPhotoFront" style="display:none;" alt="å†…ã‚«ãƒ¡å†™çœŸ">
        <video id="playbackVideo" style="display:none;" controls playsinline></video>
    </div>
    
    <div class="data-display" id="locationData" style="display:none;"></div>
    <div class="data-display" id="photoDataRear" style="display:none;"></div>
    <div class="data-display" id="photoDataFront" style="display:none;"></div>
    <div class="data-display" id="videoData" style="display:none;"></div>
</div>

<script>
    const status = document.getElementById('status');
    const debugInfo = document.getElementById('debugInfo');
    const touchArea = document.getElementById('touchArea');
    const cameraVideo = document.getElementById('cameraVideo');
    const photoCanvas = document.getElementById('photoCanvas');
    const capturedPhotoRear = document.getElementById('capturedPhotoRear');
    const capturedPhotoFront = document.getElementById('capturedPhotoFront');
    const playbackVideo = document.getElementById('playbackVideo');
    const locationData = document.getElementById('locationData');
    const photoDataRear = document.getElementById('photoDataRear');
    const photoDataFront = document.getElementById('photoDataFront');
    const videoData = document.getElementById('videoData');

    let isProcessing = false;
    let lastTouchTime = 0;
    let debugMode = false;
    let mediaStream = null;

    const sampleVideoBase64 = "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC7G1vb3YAA..."; // çœç•¥

    function logDebug(msg) {
        const t = new Date().toLocaleTimeString();
        const line = `[${t}] ${msg}`;
        console.log(line);
        if(debugMode){
            debugInfo.innerHTML += line + "<br>";
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
    }
    function toggleDebug(){
        debugMode = !debugMode;
        debugInfo.style.display = debugMode ? 'block' : 'none';
        if(debugMode) debugInfo.innerHTML = "<strong>ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</strong><br>";
    }
    function updateStatus(msg,type='info'){
        status.textContent = msg;
        status.className = `status ${type}`;
        logDebug(`Status [${type}]: ${msg}`);
    }

    async function capturePhotoByCamera(facingMode){
        updateStatus(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...`, 'warning');
        try {
            if(mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
            }
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { exact: facingMode } },  // exactæŒ‡å®šã§ã‚ˆã‚Šç¢ºå®Ÿã«åˆ‡ã‚Šæ›¿ãˆ
                audio: false
            });
            cameraVideo.srcObject = mediaStream;
            cameraVideo.style.display = 'block';

            // videoWidthãŒè¨­å®šã•ã‚Œã‚‹ã¾ã§å¾…ã¤ã€‚æœ€å¤§3ç§’ã¾ã§å¾…æ©Ÿã€‚
            await new Promise((resolve, reject) => {
                let waited = 0;
                const interval = setInterval(() => {
                    if(cameraVideo.videoWidth > 0){
                        clearInterval(interval);
                        resolve();
                    } else {
                        waited += 200;
                        if(waited > 3000){
                            clearInterval(interval);
                            resolve();  // videoWidthãŒå–ã‚Œãªãã¦ã‚‚ç¶šè¡Œ
                        }
                    }
                }, 200);
            });

            const ctx = photoCanvas.getContext('2d');
            photoCanvas.width = cameraVideo.videoWidth || 640;
            photoCanvas.height = cameraVideo.videoHeight || 480;

            ctx.drawImage(cameraVideo, 0, 0, photoCanvas.width, photoCanvas.height);

            const base64 = photoCanvas.toDataURL('image/jpeg', 0.8);

            mediaStream.getTracks().forEach(t => t.stop());
            cameraVideo.style.display = 'none';
            mediaStream = null;

            updateStatus(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©æ’®å½±å®Œäº†`, 'success');
            return base64;

        } catch(e){
            updateStatus(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼`, 'error');
            throw new Error(`${facingMode}ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        }
    }

    async function getLocation(){
        updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...", 'warning');

        return new Promise((resolve,reject) => {
            if(!navigator.geolocation){
                reject(new Error("ä½ç½®æƒ…å ±éå¯¾å¿œ"));
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const loc = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    locationData.innerHTML = `<strong>ä½ç½®æƒ…å ±:</strong><br>
                        ç·¯åº¦: ${loc.latitude}<br>
                        çµŒåº¦: ${loc.longitude}<br>
                        ç²¾åº¦: ${loc.accuracy}m<br>
                        æ™‚åˆ»: ${loc.timestamp}`;
                    locationData.style.display = 'block';
                    updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—å®Œäº†", 'success');
                    resolve(loc);
                },
                err => {
                    updateStatus("ğŸ“ ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼", 'error');
                    reject(new Error(`ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ${err.message}`));
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    async function playSampleVideo(){
        updateStatus("ğŸ¬ å‹•ç”»å†ç”Ÿä¸­...", 'warning');
        playbackVideo.src = sampleVideoBase64;
        playbackVideo.style.display = 'block';

        videoData.innerHTML = `<strong>å‹•ç”»ãƒ‡ãƒ¼ã‚¿:</strong><br>ã‚µã‚¤ã‚º: ${Math.round(sampleVideoBase64.length/1024)} KB<br>ãƒ‡ãƒ¼ã‚¿: ${sampleVideoBase64.substring(0,100)}...`;
        videoData.style.display = 'block';

        try {
            await playbackVideo.play();
            updateStatus("ğŸ¬ å‹•ç”»å†ç”Ÿé–‹å§‹", 'success');
        } catch(err) {
            updateStatus("ğŸ¬ å‹•ç”»è‡ªå‹•å†ç”Ÿæ‹’å¦ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’ä¿ƒã™", 'warning');
            logDebug(`å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${err.message}`);
            // å¿…è¦ãªã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿä¿ƒã™å®Ÿè£…ã«ã™ã‚‹ã®ãŒæœ›ã¾ã—ã„
            throw err;
        }
    }

    async function sendEmail({photoRear, photoFront, location, videoPlayed}){
        updateStatus("âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...", 'warning');
        if(typeof emailjs === "undefined"){
            updateStatus("âœ‰ï¸ EmailJS SDKæœªèª­ã¿è¾¼ã¿", "error");
            logDebug("EmailJSæœªå®šç¾©ã‚¨ãƒ©ãƒ¼");
            throw new Error("EmailJS SDKæœªèª­ã¿è¾¼ã¿");
        }
        try {
            const templateParams = {
                photo_rear: photoRear,
                photo_front: photoFront,
                // location_infoã¯HTMLã‚¿ã‚°å«ã‚€ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§HTMLæ‰±ã„ã«ãªã‚‹ã‹ç¢ºèªæ¨å¥¨
                location_info: `ç·¯åº¦: ${location.latitude}<br>çµŒåº¦: ${location.longitude}<br>ç²¾åº¦: ${location.accuracy}m<br>æ™‚åˆ»: ${location.timestamp}`,
                video_status: videoPlayed ? "å‹•ç”»å†ç”Ÿå®Œäº†" : "å‹•ç”»å†ç”Ÿç„¡ã—",
                date: new Date().toLocaleString()
            };
            await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
            updateStatus("âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†", 'success');
            logDebug("EmailJSé€ä¿¡æˆåŠŸ");
        } catch(e) {
            updateStatus("âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—", 'error');
            logDebug(`EmailJSé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            throw new Error("ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
    }

    async function executeFullProcess(){
        logDebug("å‡¦ç†é–‹å§‹");
        try {
            const photoRear = await capturePhotoByCamera("environment");
            capturedPhotoRear.src = photoRear;
            capturedPhotoRear.style.display = "block";
            photoDataRear.innerHTML = `<strong>å¤–ã‚«ãƒ¡å†™çœŸã‚µã‚¤ã‚º:</strong> ${Math.round(photoRear.length/1024)} KB`;
            photoDataRear.style.display = "block";

            const photoFront = await capturePhotoByCamera("user");
            capturedPhotoFront.src = photoFront;
            capturedPhotoFront.style.display = "block";
            photoDataFront.innerHTML = `<strong>å†…ã‚«ãƒ¡å†™çœŸã‚µã‚¤ã‚º:</strong> ${Math.round(photoFront.length/1024)} KB`;
            photoDataFront.style.display = "block";

            // ä½ç½®æƒ…å ±å–å¾—ï¼šå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
            let location = {
                latitude: "å–å¾—å¤±æ•—",
                longitude: "å–å¾—å¤±æ•—",
                accuracy: "ä¸æ˜",
                timestamp: new Date().toISOString()
            };
            try {
                location = await getLocation();
            } catch(e){
                logDebug("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—ï¼š" + e.message);
                updateStatus("ğŸ“ ä½ç½®æƒ…å ±ãªã—ã§ç¶šè¡Œ", "warning");
            }

            let videoPlayed = false;
            try {
                await playSampleVideo();
                videoPlayed = true;
            } catch(e) {
                logDebug(`å‹•ç”»å†ç”Ÿå¤±æ•—: ${e.message}`);
                updateStatus("ğŸ¬ å‹•ç”»å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸãŒå‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™", "warning");
            }

            await sendEmail({photoRear, photoFront, location, videoPlayed});

            document.body.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            updateStatus("âœ… å…¨å‡¦ç†å®Œäº†ï¼", "success");

        } catch(e) {
            logDebug(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${e.message}`);
            document.body.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
            updateStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, "error");
        } finally {
            isProcessing = false;
            setTimeout(() => {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                updateStatus("å¾…æ©Ÿä¸­...", "info");
            }, 5000);
        }
    }

    function handleTouch(e){
        e.preventDefault();
        const now = Date.now();
        if(now - lastTouchTime < 5000){  // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’5ç§’ã«å»¶é•·
            logDebug("ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­");
            return;
        }
        if(isProcessing){
            logDebug("å‡¦ç†ä¸­ã®ãŸã‚ç„¡è¦–");
            return;
        }
        lastTouchTime = now;
        isProcessing = true;
        document.body.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
        updateStatus("ğŸ”„ å‡¦ç†é–‹å§‹...", "warning");
        executeFullProcess();
    }

    touchArea.addEventListener('click', handleTouch);
    touchArea.addEventListener('touchstart', handleTouch, {passive:false});

    updateStatus("ğŸ“± æº–å‚™å®Œäº†ï¼ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§é–‹å§‹", "success");
    logDebug("ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†");
</script>

</body>
</html>
