<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚«ãƒ¡ãƒ©ï¼‹ä½ç½®ï¼‹é€ä¿¡ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .container { max-width: 800px; margin: auto; text-align: center; }
  .touch-area {
    border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px;
    background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0;
    cursor: pointer;
    user-select: none;
  }
  .status {
    background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px;
  }
  .debug-info {
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
    font-family: monospace;
    font-size: 12px;
    height: 150px;
    overflow-y: auto;
    text-align: left;
    display: none;
  }
  .debug-toggle {
    position: fixed; top: 10px; right: 10px;
    background: rgba(0,0,0,0.6);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
<button class="debug-toggle" onclick="toggleDebug()">Debug</button>
<div class="container">
  <h1>ğŸ“· 3é€£å†™ï¼‹ä½ç½®é€ä¿¡ï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>
  <p>å¤–ã‚«ãƒ¡ â†’ å†…ã‚«ãƒ¡ â†’ ä½ç½® â†’ EmailJSé€ä¿¡</p>
  <div class="touch-area" id="touchArea">â–¶ï¸ ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ</div>
  <div class="status" id="status">å¾…æ©Ÿä¸­</div>
  <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
  <canvas id="photoCanvas" style="display:none;"></canvas>
  <div class="debug-info" id="debugInfo"></div>
</div>

<script>
  emailjs.init("cPjKBUm_i6HebDQF7");

  const touchArea = document.getElementById('touchArea');
  const status = document.getElementById('status');
  const debugInfo = document.getElementById('debugInfo');
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('photoCanvas');
  let stream = null;
  let isProcessing = false;
  let debugMode = false;

  function toggleDebug(){
    debugMode = !debugMode;
    debugInfo.style.display = debugMode ? 'block' : 'none';
    if(debugMode) {
      debugInfo.innerHTML = "[Debugãƒ¢ãƒ¼ãƒ‰ON]<br>";
    }
  }

  function logDebug(msg) {
    const t = new Date().toLocaleTimeString();
    const line = `[${t}] ${msg}`;
    console.log(line);
    if(debugMode){
      debugInfo.innerHTML += line + "<br>";
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }
  }

  function updateStatus(msg, bgColor = '') {
    status.textContent = msg;
    status.style.background = bgColor || 'rgba(0,0,0,0.4)';
    logDebug("Status: " + msg);
  }

  async function waitVideoReady(videoElem) {
    if (videoElem.readyState >= 2) return;
    return new Promise(resolve => {
      videoElem.onloadedmetadata = () => resolve();
    });
  }

  async function capturePhotos(facingMode) {
    updateStatus(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©æ’®å½±ä¸­...`, "#ffa726");
    try {
      if (stream) {
        logDebug("æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢");
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode }, audio: false
      });
      video.srcObject = stream;
      video.style.display = 'block';

      await waitVideoReady(video);
      logDebug(`ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ é–‹å§‹ã€‚è§£åƒåº¦: ${video.videoWidth}x${video.videoHeight}`);

      const ctx = canvas.getContext('2d');
      const photos = [];
      for (let i = 0; i < 3; i++) {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.15);
        photos.push(dataUrl);
        logDebug(`æ’®å½± ${i + 1} æšç›® ã‚µã‚¤ã‚º: ${Math.round(dataUrl.length / 1024)} KB`);
        await new Promise(r => setTimeout(r, 50));
      }

      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.style.display = 'none';
      logDebug(`${facingMode}ã‚«ãƒ¡ãƒ©æ’®å½±å®Œäº†`);
      return photos;

    } catch (e) {
      updateStatus("ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼", "#ef5350");
      logDebug(`ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${e.message || e}`);
      throw e;
    }
  }

  async function getLocationInfo() {
    updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...", "#29b6f6");
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("ä½ç½®æƒ…å ±éå¯¾å¿œ"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const loc = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            acc: pos.coords.accuracy,
            time: new Date(pos.timestamp).toLocaleString()
          };
          logDebug(`ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ç·¯åº¦${loc.lat}, çµŒåº¦${loc.lon}, ç²¾åº¦${loc.acc}m`);
          resolve(loc);
        },
        err => {
          logDebug(`ä½ç½®æƒ…å ±å–å¾—å¤±æ•—: ${err.message}`);
          reject(err);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  }

  async function sendEmail({ rearPhotos, frontPhotos, location }) {
    updateStatus("âœ‰ï¸ Emailé€ä¿¡ä¸­...", "#29b6f6");
    rearPhotos.forEach((p, i) => logDebug(`å¤–ã‚«ãƒ¡å†™çœŸ${i + 1}ã‚µã‚¤ã‚º: ${Math.round(p.length / 1024)} KB`));
    frontPhotos.forEach((p, i) => logDebug(`å†…ã‚«ãƒ¡å†™çœŸ${i + 1}ã‚µã‚¤ã‚º: ${Math.round(p.length / 1024)} KB`));
    logDebug(`ä½ç½®æƒ…å ±: ç·¯åº¦${location.lat}, çµŒåº¦${location.lon}, ç²¾åº¦${location.acc}m`);

    const templateParams = {
      photo_rear1: rearPhotos[0],
      photo_rear2: rearPhotos[1],
      photo_rear3: rearPhotos[2],
      photo_front1: frontPhotos[0],
      photo_front2: frontPhotos[1],
      photo_front3: frontPhotos[2],
      location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lon}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
      date: new Date().toLocaleString()
    };

    try {
      await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
      updateStatus("âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼", "#66bb6a");
      logDebug("EmailJSé€ä¿¡æˆåŠŸ");
    } catch (e) {
      updateStatus("âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—", "#ef5350");
      const errMsg = e && e.text ? e.text : (e && e.message ? e.message : JSON.stringify(e));
      logDebug(`EmailJSé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${errMsg}`);
      throw e;
    }
  }

  async function runAll() {
    if (isProcessing) {
      logDebug("âŒ å‡¦ç†ä¸­ã§ã™ã€‚äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢ã—ã¾ã™ã€‚");
      return;
    }
    isProcessing = true;
    try {
      updateStatus("ğŸ”„ å¤–ã‚«ãƒ¡æ’®å½±...", "#ffa726");
      const rearPhotos = await capturePhotos("environment");

      updateStatus("ğŸ”„ å†…ã‚«ãƒ¡æ’®å½±...", "#ffa726");
      const frontPhotos = await capturePhotos("user");

      let location;
      try {
        location = await getLocationInfo();
      } catch (e) {
        location = {
          lat: "å–å¾—å¤±æ•—",
          lon: "å–å¾—å¤±æ•—",
          acc: "ä¸æ˜",
          time: new Date().toLocaleString()
        };
        updateStatus("âš ï¸ ä½ç½®æƒ…å ±å¤±æ•—", "#ffb300");
      }

      await sendEmail({ rearPhotos, frontPhotos, location });
    } catch (e) {
      logDebug("å…¨ä½“å‡¦ç†ã‚¨ãƒ©ãƒ¼: " + (e.message || e));
      updateStatus("âŒ å…¨ä½“å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼", "#ef5350");
    } finally {
      isProcessing = false;
    }
  }

  touchArea.addEventListener('click', runAll);
  touchArea.addEventListener('touchstart', e => {
    e.preventDefault();
    runAll();
  }, { passive: false });
</script>
</body>
</html>
