<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¢ãƒ—ãƒª</title>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            cursor: pointer;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .touch-area {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }
        
        .touch-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .media-container {
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        video, img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .data-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        
        .error { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .success { color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .warning { color: #ff9800; background: rgba(255, 152, 0, 0.1); }
        
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>

    <!-- EmailJS SDKèª­ã¿è¾¼ã¿ï¼†åˆæœŸåŒ– -->
    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("cPjKBUm_i6HebDQF7");
        })();
    </script>
</head>
<body>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    
    <div class="container">
        <h1>ğŸ“± ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¢ãƒ—ãƒª</h1>
        <p>ç”»é¢ã‚’ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å†™çœŸæ’®å½±ã€ä½ç½®æƒ…å ±å–å¾—ã€å‹•ç”»å†ç”Ÿã‚’è¡Œã„ã¾ã™</p>
        
        <div class="touch-area" id="touchArea">
            <h2>ğŸ“± ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§å®Ÿè¡Œ</h2>
            <p>PC: ã‚¯ãƒªãƒƒã‚¯ | ã‚¹ãƒãƒ›: ã‚¿ãƒƒãƒ</p>
            <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
                å†™çœŸæ’®å½± â†’ ä½ç½®æƒ…å ±å–å¾— â†’ å‹•ç”»å†ç”Ÿ â†’ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            </div>
        </div>
        
        <div class="status" id="status">å¾…æ©Ÿä¸­...</div>
        
        <div class="debug-info" id="debugInfo"></div>
        
        <div class="media-container">
            <video id="cameraVideo" autoplay muted style="display: none;"></video>
            <canvas id="photoCanvas" style="display: none;"></canvas>
            <img id="capturedPhoto" style="display: none;" alt="æ’®å½±ã•ã‚ŒãŸå†™çœŸ">
            <video id="playbackVideo" style="display: none;" controls></video>
        </div>
        
        <div class="data-display" id="locationData" style="display: none;"></div>
        <div class="data-display" id="photoData" style="display: none;"></div>
        <div class="data-display" id="videoData" style="display: none;"></div>
    </div>

    <!-- EmailJS é€ä¿¡ç”¨ã®éš ã—ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="emailForm" style="display:none;">
      <input type="hidden" name="photo_data" />
      <input type="hidden" name="location_info" />
      <input type="hidden" name="video_status" />
    </form>

    <script>
        // DOMè¦ç´ å–å¾—
        const status = document.getElementById('status');
        const debugInfo = document.getElementById('debugInfo');
        const touchArea = document.getElementById('touchArea');
        const cameraVideo = document.getElementById('cameraVideo');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const playbackVideo = document.getElementById('playbackVideo');
        const locationData = document.getElementById('locationData');
        const photoData = document.getElementById('photoData');
        const videoData = document.getElementById('videoData');
        
        // çŠ¶æ…‹ç®¡ç†
        let isProcessing = false;
        let lastTouchTime = 0;
        let mediaStream = null;
        let debugMode = false;
        
        // ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»ãƒ‡ãƒ¼ã‚¿ï¼ˆBase64ï¼‰
        const sampleVideoBase64 = "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC7G1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIXdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAABAAAAAAAAAAAAAAAAACRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAALuAAAAAAABVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAABz21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAY9zdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAgABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3959l7BQAAAwABAAADADIPFi2WAQAEaO+jyyLA/fj4AAAAABx1dWlka2hA8l8kT8W6OaUbzwMj8wAAAAAAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTguMjkuMTAw";
        
        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            if (debugMode) {
                debugInfo.innerHTML += logMessage + '<br>';
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                debugInfo.innerHTML = '<strong>ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</strong><br>';
            }
        }
        
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            logDebug(`Status [${type}]: ${message}`);
        }
        
        // EmailJSã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        async function sendEmail(photoBase64, location) {
            const form = document.getElementById('emailForm');
            // Base64ãƒ‡ãƒ¼ã‚¿ãŒé•·ã™ãã‚‹ã¨ãƒ¡ãƒ¼ãƒ«ãŒé€ã‚Œãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€å…ˆé ­500æ–‡å­—ã«åˆ¶é™
            form.photo_data.value = photoBase64.substring(0, 500);
            form.location_info.value = `ç·¯åº¦: ${location.latitude}, çµŒåº¦: ${location.longitude}, ç²¾åº¦: ${location.accuracy}m, æ™‚åˆ»: ${location.timestamp}`;
            form.video_status.value = "å‹•ç”»å†ç”Ÿå®Œäº†";
        
            try {
                const result = await emailjs.sendForm('service_ja2c09x', 'template_2fp2jrg', form);
                logDebug(`ğŸ“© ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ${result.text}`);
                updateStatus('ğŸ“© ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ', 'success');
            } catch (error) {
                logDebug(`ğŸ“© ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ${error.text || error.message}`);
                updateStatus(`ğŸ“© ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ${error.text || error.message}`, 'error');
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•°
        async function executeFullProcess() {
            logDebug('ãƒ•ãƒ«ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
            
            try {
                // 1. å†™çœŸæ’®å½±
                logDebug('å†™çœŸæ’®å½±é–‹å§‹');
                const photoBase64 = await capturePhoto();
                logDebug('å†™çœŸæ’®å½±å®Œäº†');
                
                // 2. ä½ç½®æƒ…å ±å–å¾—
                logDebug('ä½ç½®æƒ…å ±å–å¾—é–‹å§‹');
                const location = await getLocation();
                logDebug('ä½ç½®æƒ…å ±å–å¾—å®Œäº†');
                
                // 3. å‹•ç”»å†ç”Ÿ
                logDebug('å‹•ç”»å†ç”Ÿé–‹å§‹');
                await playBase64Video();
                logDebug('å‹•ç”»å†ç”Ÿå®Œäº†');
                
                // 4. ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                logDebug('ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹');
                await sendEmail(photoBase64, location);
                logDebug('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
                
                // æˆåŠŸè¡¨ç¤º
                document.body.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                updateStatus('âœ… å…¨å‡¦ç†å®Œäº†ï¼', 'success');
                
            } catch (error) {
                logDebug(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`);
                document.body.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                updateStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                setTimeout(() => {
                    document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    updateStatus('å¾…æ©Ÿä¸­...', 'info');
                }, 5000);
            }
        }
        
        // å†™çœŸæ’®å½±
        async function capturePhoto() {
            updateStatus('ğŸ“¸ ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...', 'warning');
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                
                cameraVideo.srcObject = mediaStream;
                cameraVideo.style.display = 'block';
                
                // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒãŒå®‰å®šã™ã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿï¼ˆ2ç§’ï¼‰
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const canvas = photoCanvas;
                const context = canvas.getContext('2d');
                canvas.width = cameraVideo.videoWidth || 640;
                canvas.height = cameraVideo.videoHeight || 480;
                
                context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                const photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                
                capturedPhoto.src = photoBase64;
                capturedPhoto.style.display = 'block';
                
                photoData.innerHTML = `<strong>æ’®å½±å†™çœŸ:</strong><br>ã‚µã‚¤ã‚º: ${Math.round(photoBase64.length / 1024)}KB<br>ãƒ‡ãƒ¼ã‚¿: ${photoBase64.substring(0, 100)}...`;
                photoData.style.display = 'block';
                
                mediaStream.getTracks().forEach(track => track.stop());
                cameraVideo.style.display = 'none';
                
                updateStatus('ğŸ“¸ å†™çœŸæ’®å½±å®Œäº†', 'success');
                return photoBase64;
                
            } catch (error) {
                updateStatus('ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', 'error');
                throw new Error(`ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ä½ç½®æƒ…å ±å–å¾—
        async function getLocation() {
            updateStatus('ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...', 'warning');
            
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('ä½ç½®æƒ…å ±éå¯¾å¿œ'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        locationData.innerHTML = `<strong>ä½ç½®æƒ…å ±:</strong><br>
                            ç·¯åº¦: ${location.latitude}<br>
                            çµŒåº¦: ${location.longitude}<br>
                            ç²¾åº¦: ${location.accuracy}m<br>
                            æ™‚åˆ»: ${location.timestamp}`;
                        locationData.style.display = 'block';
                        
                        updateStatus('ğŸ“ ä½ç½®æƒ…å ±å–å¾—å®Œäº†', 'success');
                        resolve(location);
                    },
                    (error) => {
                        updateStatus('ğŸ“ ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼', 'error');
                        reject(new Error(`ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ${error.message}`));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        // å‹•ç”»å†ç”Ÿ
        async function playBase64Video() {
            updateStatus('ğŸ¬ å‹•ç”»å†ç”Ÿä¸­...', 'warning');
            
            try {
                playbackVideo.src = sampleVideoBase64;
                playbackVideo.style.display = 'block';
                
                videoData.innerHTML = `<strong>å‹•ç”»ãƒ‡ãƒ¼ã‚¿:</strong><br>ã‚µã‚¤ã‚º: ${Math.round(sampleVideoBase64.length / 1024)}KB<br>ãƒ‡ãƒ¼ã‚¿: ${sampleVideoBase64.substring(0, 100)}...`;
                videoData.style.display = 'block';
                
                await playbackVideo.play();
                updateStatus('ğŸ¬ å‹•ç”»å†ç”Ÿé–‹å§‹', 'success');
                
            } catch (error) {
                updateStatus('ğŸ¬ å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼', 'error');
                throw new Error(`å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleTouch(event) {
            const currentTime = Date.now();
            
            // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆ2ç§’ï¼‰
            if (currentTime - lastTouchTime < 2000) {
                logDebug('ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­');
                return;
            }
            lastTouchTime = currentTime;
            
            if (isProcessing) {
                logDebug('å‡¦ç†ä¸­ã®ãŸã‚ç„¡è¦–');
                return;
            }
            
            logDebug(`ã‚¿ãƒƒãƒæ¤œå‡º: ${event.type}`);
            isProcessing = true;
            document.body.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
            updateStatus('ğŸ”„ å‡¦ç†é–‹å§‹...', 'warning');
            
            // å‡¦ç†å®Ÿè¡Œ
            executeFullProcess();
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        touchArea.addEventListener('click', handleTouch);
        touchArea.addEventListener('touchstart', handleTouch, { passive: false });
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        document.addEventListener('click', function(e) {
            if (e.target.closest('.touch-area')) {
                // touchAreaã®ã‚¤ãƒ™ãƒ³ãƒˆã«ä»»ã›ã‚‹
                return;
            }
            if (e.target.tagName === 'BUTTON') {
                // ãƒœã‚¿ãƒ³ã¯é™¤å¤–
                return;
            }
            // ãã®ä»–ã®å ´æ‰€ã‚‚ã‚¿ãƒƒãƒå¯èƒ½ã«ã™ã‚‹å ´åˆ
            // handleTouch(e);
        });
        
        // åˆæœŸåŒ–
        updateStatus('ğŸ“± æº–å‚™å®Œäº†ï¼ã‚¿ãƒƒãƒã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹', 'success');
        logDebug('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>
