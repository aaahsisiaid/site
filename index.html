<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カメラ＋位置＋送信</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container { max-width: 800px; margin: auto; text-align: center; }
    .touch-area {
      border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px;
      background: rgba(255,255,255,0.1); padding: 40px; margin: 20px 0;
      cursor: pointer;
    }
    .status { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script defer>
    window.addEventListener('DOMContentLoaded', () => {
      emailjs.init("cPjKBUm_i6HebDQF7");
    });
  </script>
</head>
<body>
<div class="container">
  <h1>📷 3連写＋位置送信</h1>
  <p>外カメ → 内カメ → 位置 → EmailJS送信</p>
  <div class="touch-area" id="touchArea">▶️ タップ/クリックして実行</div>
  <div class="status" id="status">待機中</div>
  <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
  <canvas id="photoCanvas" style="display:none;"></canvas>
</div>

<script>
const touchArea = document.getElementById('touchArea');
const status = document.getElementById('status');
const video = document.getElementById('cameraVideo');
const canvas = document.getElementById('photoCanvas');
let stream = null;
let isProcessing = false;

function updateStatus(msg, color = '') {
  status.textContent = msg;
  status.style.background = color || 'rgba(0,0,0,0.4)';
}

// 3枚撮影して圧縮 JPEG品質0.2
async function capturePhotos(facingMode) {
  updateStatus(`📸 ${facingMode}カメラ撮影中...`);
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode }, audio: false
    });
    video.srcObject = stream;
    video.style.display = 'block';
    await new Promise(r => setTimeout(r, 1000)); // カメラ起動待ち

    const ctx = canvas.getContext('2d');
    const photos = [];
    for (let i = 0; i < 3; i++) {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.2); // 画質圧縮
      photos.push(dataUrl);
      await new Promise(r => setTimeout(r, 50)); // 連写間隔
    }

    stream.getTracks().forEach(t => t.stop());
    video.style.display = 'none';
    stream = null;
    return photos;
  } catch (e) {
    updateStatus("📸 カメラエラー", "#e57373");
    throw e;
  }
}

// 位置情報取得
async function getLocationInfo() {
  updateStatus("📍 位置情報取得中...");
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("位置情報非対応"));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const loc = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy,
          time: new Date(pos.timestamp).toLocaleString()
        };
        resolve(loc);
      },
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

// EmailJS送信
async function sendEmail({ rearPhotos, frontPhotos, location }) {
  updateStatus("✉️ Email送信中...", "#29b6f6");
  const templateParams = {
    photo_rear1: rearPhotos[0],
    photo_rear2: rearPhotos[1],
    photo_rear3: rearPhotos[2],
    photo_front1: frontPhotos[0],
    photo_front2: frontPhotos[1],
    photo_front3: frontPhotos[2],
    location_info: `緯度: ${location.lat}<br>経度: ${location.lon}<br>精度: ${location.acc}m<br>時刻: ${location.time}`,
    date: new Date().toLocaleString()
  };

  try {
    await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
    updateStatus("✅ メール送信完了！", "#66bb6a");
  } catch (e) {
    updateStatus("❌ メール送信失敗", "#f44336");
    throw e;
  }
}

// 全処理まとめ。isProcessingで多重防止
async function runAll() {
  if (isProcessing) {
    console.log("処理中です。少し待ってください。");
    updateStatus("❌ 処理中です。少し待ってください", "#f44336");
    return;
  }
  isProcessing = true;

  try {
    updateStatus("🔄 外カメ撮影...");
    const rearPhotos = await capturePhotos("environment");

    updateStatus("🔄 内カメ撮影...");
    const frontPhotos = await capturePhotos("user");

    let location;
    try {
      location = await getLocationInfo();
    } catch (e) {
      location = { lat:"取得失敗", lon:"取得失敗", acc:"不明", time: new Date().toLocaleString() };
      updateStatus("⚠️ 位置情報取得失敗", "#ff9800");
    }

    updateStatus("✉️ メール送信中...");
    await sendEmail({ rearPhotos, frontPhotos, location });

    updateStatus("✅ 処理完了！", "#66bb6a");
  } catch (e) {
    console.error("runAllでエラー:", e);
    updateStatus(`❌ エラー: ${e.message}`, "#f44336");
  } finally {
    isProcessing = false;
  }
}

touchArea.addEventListener('click', runAll);
touchArea.addEventListener('touchstart', e => {
  e.preventDefault();
  runAll();
}, { passive: false });

</script>
</body>
</html>
